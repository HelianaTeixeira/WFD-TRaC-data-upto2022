---
title: "prepareBQEdata"
author: "HT"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(openxlsx)
library(tidyverse)
library(dplyr)
library(tidyr)
```

## Data description

This script prepares the previously extracted biological EQS classifications (BQE from WISE-4 & WISE-2) to allow joining it with the water quality data (WQ from WISE-6) for selected supporting elements (SE), for both TRaC water categories (TW & CW).

EQS:
* BQE - From WISE2, EQS aggWB data was extracted, for all years available.

* BQE - From WISE4, only WB aggregated EQS data (i.e., categories, not EQR) was available for the 1st and 2nd reporting cycle years 2010 and 2016.

EQR:
* BQE - From WISE2, datasets for TW & CW with EQR & EQS aggregated by Site and year/season, (except for EE, IE and SI for which only already aggregated data by WB was available at source) were already generated while extracting BQE data using script "extractSOE-WISE2-Biology.R".

### A. Import BQE data for TraC Waters per year
```{r Import WISE4 Biota EQS classifications to Wide format}
#TW
dat_WFD_TW <- readRDS(here("Data","dat_W4_TW_BQE.rds")) #import biology
#check available reporting years
unique(dat_WFD_TW$cYear) # 2010, 2016

dat_WFD_TW.wide <- dat_WFD_TW %>% 
  select(countryCode,euSurfaceWaterBodyCode,surfaceWaterBodyName,surfaceWaterBodyTypeCode,naturalAWBHMWB,cYear,qeCode,qeStatusOrPotentialValue,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode) %>% 
  pivot_wider(names_from = qeCode, 
              values_from = qeStatusOrPotentialValue
              )   

any(duplicated(dat_WFD_TW.wide)) #check for duplicates FALSE
colnames(dat_WFD_TW.wide) <- make.names(names(dat_WFD_TW.wide)) # create valid names

#CW
dat_WFD_CW <- readRDS(here("Data","dat_W4_CW_BQE.rds")) #import biology
#check available reporting years
unique(dat_WFD_CW$cYear) # 2010, 2016

dat_WFD_CW.wide <- dat_WFD_CW %>% 
  select(countryCode,euSurfaceWaterBodyCode,surfaceWaterBodyName,surfaceWaterBodyTypeCode,naturalAWBHMWB,cYear,qeCode,qeStatusOrPotentialValue,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode) %>% 
  pivot_wider(names_from = qeCode, 
              values_from = qeStatusOrPotentialValue
              )
any(duplicated(dat_WFD_CW.wide)) #check for duplicates FALSE
colnames(dat_WFD_CW.wide) <- make.names(names(dat_WFD_CW.wide)) # create valid names
```

```{r Import WISE2 Biota EQS classifications to Wide format}
#TW & CW SiteMean per year all period of data
dat_BQE_TW <- readRDS(here("Data","dat_BQE_TW.rds")) #import biology
dat_BQE_CW <- readRDS(here("Data","dat_BQE_CW.rds")) #import biology

#TRaC aggregated by WB per year all period of data
dat_BQE_TRaC.aggrWB <- readRDS(here("Data","dat_BQE_TRaC_aggrWB_all.rds")) #import biology aggregated by WB all years 

#TW
dat_BQE_TW_wideEQS <- dat_BQE_TW %>% 
  select(countryCode,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         monitoringSiteIdentifier,monitoringSiteIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, 
              values_from = resultEcologicalStatusClassValue,
              values_fn = mean #how to combine duplicates
              )   

colnames(dat_BQE_TW_wideEQS) <- make.names(names(dat_BQE_TW_wideEQS)) # create valid names
any(duplicated(dat_BQE_TW_wideEQS)) #check for duplicates FALSE

#CW
dat_BQE_CW_wideEQS <- dat_BQE_CW %>% 
  select(countryCode,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         monitoringSiteIdentifier,monitoringSiteIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, 
              values_from = resultEcologicalStatusClassValue,
              values_fn = mean #how to combine duplicates
              )   

colnames(dat_BQE_CW_wideEQS) <- make.names(names(dat_BQE_CW_wideEQS)) # create valid names
any(duplicated(dat_BQE_CW_wideEQS)) #check for duplicates FALSE

#TRaC aggWB
dat_BQE_TRaC.aggrWB_wideEQS <- dat_BQE_TRaC.aggrWB %>% 
  select(countryCode,parameterWaterBodyCategory,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         waterBodyIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, 
              values_from = resultEcologicalStatusClassValue,
              values_fn = mean #how to combine duplicates
              )

colnames(dat_BQE_TRaC.aggrWB_wideEQS) <- make.names(names(dat_BQE_TRaC.aggrWB_wideEQS)) # create valid names
any(duplicated(dat_BQE_TRaC.aggrWB_wideEQS)) #check for duplicates FALSE

```

### B. Combine WISE4 & WISE2 Biological EQS data for all available years
```{r harmonise BQEs-EQS names WISE2 & WISE4}
#1st harmonise BQE names in both reporting databases 
names(dat_WFD_TW.wide) #wise4
names(dat_WFD_CW.wide) #wise4
names(dat_BQE_TW_wideEQS) #wise2
names(dat_BQE_CW_wideEQS) #wise2
names(dat_BQE_TRaC.aggrWB_wideEQS) #wise2

#TW 
dat_WFD_TW.wide <- dat_WFD_TW.wide %>% #wise4
  rename(
    InvertebrateEQS = QE1.3...Benthic.invertebrates,
    FishEQS = QE1.4...Fish,
    MacroalgaeEQS = QE1.2.1...Macroalgae,
    PhytoplanktonEQS = QE1.1...Phytoplankton,
    otherAquaticFloraEQS = QE1.2...Other.aquatic.flora,
    MacrophytesEQS = QE1.2.3...Macrophytes,
    AngiospermsEQS = QE1.2.2...Angiosperms,
    PhytobenthosEEQS = QE1.2.4...Phytobenthos
  )

dat_BQE_TW_wideEQS <- dat_BQE_TW_wideEQS %>% #wise2
  rename(
    InvertebrateGEQS = InvertebrateEQR_G,
    FishEQS = FishEQR,
    MacroalgaeEQS = MacroalgaeEQR,
    PhytoplanktonEQS = PhytoplanktonEQR,
    PhytoplanktonEEQS = PhytoplanktonEQR_E,
    AngiospermsEQS = AngiospermsEQR,
    PhytobenthosEEQS = PhytobenthosEQR_E,
    InvertebrateEQS = InvertebrateEQR
  )

#CW
dat_WFD_CW.wide <- dat_WFD_CW.wide %>% #wise4
  rename(
    InvertebrateEQS = QE1.3...Benthic.invertebrates,
    FishEQS = QE1.4...Fish,
    MacroalgaeEQS = QE1.2.1...Macroalgae,
    PhytoplanktonEQS = QE1.1...Phytoplankton,
    otherAquaticFloraEQS = QE1.2...Other.aquatic.flora,
    MacrophytesEQS = QE1.2.3...Macrophytes,
    AngiospermsEQS = QE1.2.2...Angiosperms,
    PhytobenthosEEQS = QE1.2.4...Phytobenthos
  )

dat_BQE_CW_wideEQS <- dat_BQE_CW_wideEQS %>% #wise2
  rename(
    InvertebrateGEQS = InvertebrateEQR_G,
    MacroalgaeEQS = MacroalgaeEQR,
    PhytoplanktonEQS = PhytoplanktonEQR,
    PhytobenthosEEQS = PhytobenthosEQR_E,
    AngiospermsEQS = AngiospermsEQR,
    InvertebrateEQS = InvertebrateEQR
  )

#TraC
dat_BQE_TRaC.aggrWB_wideEQS <- dat_BQE_TRaC.aggrWB_wideEQS %>% #wise2
  rename(
    MacroalgaeEQS = MacroalgaeEQR,
    PhytoplanktonEQS = PhytoplanktonEQR,
    AngiospermsEQS = AngiospermsEQR,
    InvertebrateEQS = InvertebrateEQR,
    FishEQS = FishEQR
  )

```

```{r prepare data to merge BQE aggrWB from WISE2 & WISE4 }
#1st check for differences in variables names in wise 4 TW vs CW
setdiff(names(dat_WFD_TW.wide),names(dat_WFD_CW.wide)) #no difference between TW & CW WISE4

#2nd merge TW and CW in WISE4 into unique df
dat_WFD_TRaC.aggrWB_wideEQS <- bind_rows(TW = dat_WFD_TW.wide, CW = dat_WFD_CW.wide, 
                                         .id = "parameterWaterBodyCategory") #id source water category dataset

#3rd inspect WISE4 vs WISE2 TRaC aggregated by WB
names(dat_WFD_TRaC.aggrWB_wideEQS) #WISE4
names(dat_BQE_TRaC.aggrWB_wideEQS) #WISE2

intersect(names(dat_WFD_TRaC.aggrWB_wideEQS),names(dat_BQE_TRaC.aggrWB_wideEQS)) 
symdiff(names(dat_WFD_TRaC.aggrWB_wideEQS),names(dat_BQE_TRaC.aggrWB_wideEQS))

#DROP:
unique(dat_BQE_TRaC.aggrWB_wideEQS$waterBodyIdentifierScheme)     
#"waterBodyIdentifierScheme" (wise 2)

# WISE2 clean data and aggregate by WFD Cycle BEFORE merge with WISE4
# add WFD Cycle year variable to wise 2 "cYear"
cYear <- list(
  `baseline`= 2000:2003,
  `2010` = 2004:2009,
  `2016` = 2010:2015,
  `2022` = 2016:2021,
  `2028` = 2022:2027
)

dat_BQE_TRaC.aggrWBcYear_wideEQS <- dat_BQE_TRaC.aggrWB_wideEQS %>% # wise2
  select(-waterBodyIdentifierScheme) %>%
  mutate(cYear=case_when(
    phenomenonTimeReferenceYear %in% cYear$baseline ~ 2000,
    phenomenonTimeReferenceYear %in% cYear$`2010` ~ 2010,
    phenomenonTimeReferenceYear %in% cYear$`2016` ~ 2016,
    phenomenonTimeReferenceYear %in% cYear$`2022` ~ 2022,
    phenomenonTimeReferenceYear %in% cYear$`2028` ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-phenomenonTimeReferenceYear)

#4th summarise WISE2 BQE EQS data per per WB and WFD cycle
#to include mean EQS value rounded per BQE + count samples
dat_BQE_TRaC.aggrWBcYear_wideMeanEQS <- dat_BQE_TRaC.aggrWBcYear_wideEQS %>%
  group_by(parameterWaterBodyCategory, countryCode, 
           waterBodyName, waterBodyIdentifier, parameterNCSWaterBodyType,
           parameterNaturalAWBHMWB, cYear
           ) %>%
  summarise(
    # mean values for all EQS rounded to nearest integer, then clipped to 1â€“5 scale
    across(
      ends_with("EQS"),
      ~ {
        m <- mean(.x, na.rm = TRUE)
        if (is.nan(m)) return(NA_real_)     # keep NA
        m_round <- round(m, 0)
        m_safe  <- min(max(m_round, 1), 5) # force between 1 and 5
        m_safe
      },
      .names = "{.col}_mean"
    ),
    
    # count of non-missing records per EQS value
    across(
      ends_with("EQS"),
      ~ sum(!is.na(.x)),
      .names = "{.col}_n"
    ),
    
    .groups = "drop"
  )


#5th join tables WISE4 vs WISE2 TRaC aggregated by WB
names(dat_WFD_TRaC.aggrWB_wideEQS) #WISE4
names(dat_BQE_TRaC.aggrWBcYear_wideMeanEQS) #WISE2

dat_BQE_TRaC.aggrWBcYear_wideMeanEQSclean<- dat_BQE_TRaC.aggrWBcYear_wideMeanEQS %>% 
  select(-PhytoplanktonEQS_n, -MacroalgaeEQS_n, -InvertebrateEQS_n, -AngiospermsEQS_n, -FishEQS_n) #drop count of samples to mean EQS in WISE2

symdiff(names(dat_BQE_TRaC.aggrWBcYear_wideMeanEQSclean),names(dat_WFD_TRaC.aggrWB_wideEQS)) #check all vars not shared between WISE4 & WISE2
#Keep & match variable names in join:
#"parameterWaterBodyCategory","countryCode",
#"euSurfaceWaterBodyCode" = "waterBodyIdentifier",
#"surfaceWaterBodyName" = "waterBodyName",
#"surfaceWaterBodyTypeCode"  = "parameterNCSWaterBodyType",
#"naturalAWBHMWB" =  "parameterNaturalAWBHMWB",
#"surfaceWaterBodyIntercalibrationType",
#"surfaceWaterBodyIntercalibrationTypeCode",
#"PhytoplanktonEQS" =  "PhytoplanktonEQS_mean",
#"MacroalgaeEQS" = "MacroalgaeEQS_mean",
#"AngiospermsEQS" = "AngiospermsEQS_mean",
#"InvertebrateEQS" = "InvertebrateEQS_mean",
#"FishEQS" = "FishEQS_mean",
#"MacrophytesEQS",
#"otherAquaticFloraEQS",
#"PhytobenthosEEQS"

```

```{r merge WISE4 & WISE2 TRaC aggregated by WB and per Cycle}
#merge EQS WISE4 & WISE2 TRaC aggregated by WB full_join to keep all data
  dat_EQS_aggrWBCycles  <- full_join(dat_BQE_TRaC.aggrWBcYear_wideMeanEQSclean,dat_WFD_TRaC.aggrWB_wideEQS,
          by=c("parameterWaterBodyCategory",
               "cYear",
               "countryCode",
               "waterBodyIdentifier" = "euSurfaceWaterBodyCode", #establish equivalence where names differ
               "waterBodyName" ="surfaceWaterBodyName",
               "parameterNCSWaterBodyType" = "surfaceWaterBodyTypeCode",
               "parameterNaturalAWBHMWB" =  "naturalAWBHMWB",
               "PhytoplanktonEQS_mean" = "PhytoplanktonEQS",
               "MacroalgaeEQS_mean" = "MacroalgaeEQS",
               "AngiospermsEQS_mean" = "AngiospermsEQS",
               "InvertebrateEQS_mean" = "InvertebrateEQS",
               "FishEQS_mean" = "FishEQS"
               )
  )

  #rename variables for accuracy, EQS not EQR
  dat_EQS_aggrWBCycles <- dat_EQS_aggrWBCycles %>%
    rename( 
    "PhytoplanktonEQS"="PhytoplanktonEQS_mean",
    "MacroalgaeEQS"="MacroalgaeEQS_mean",
    "InvertebrateEQS"="InvertebrateEQS_mean",
    "AngiospermsEQS"="AngiospermsEQS_mean",
    "FishEQS"="FishEQS_mean"
  )
  
 #checks
 length(unique(dat_EQS_aggrWBCycles$surfaceWaterBodyIntercalibrationTypeCode))
 unique(dat_EQS_aggrWBCycles$surfaceWaterBodyIntercalibrationTypeCode)
 
 #RW observations misclassified as CW, dropped
    dat_EQS_aggrWBCycles <- dat_EQS_aggrWBCycles %>%
      filter(!surfaceWaterBodyIntercalibrationTypeCode %in% c("RW-R-M4", "RW-R-M1"))

#fill in missing ICtype code for WISE2 periods using WISE4 available IC common Types codes per water body
    dat_EQS_aggrWBCycles_ICtypes <- dat_EQS_aggrWBCycles %>%
      group_by(waterBodyIdentifier) %>%
      # Fill missing codes using available IC TypeCode for the same water body
      tidyr::fill(surfaceWaterBodyIntercalibrationTypeCode, .direction = "downup") %>%
      ungroup()
   
#check
dat_EQS_aggrWBCycles_ICtypes %>% 
      group_by(waterBodyIdentifier,surfaceWaterBodyIntercalibrationTypeCode,cYear) %>%
  summarise(n=n(), 
              .groups = "drop") %>%
  arrange(desc(cYear),
          desc(n)
              )

dat_EQS_aggrWBCycles_ICtypes <- dat_EQS_aggrWBCycles_ICtypes %>%
  mutate(
    surfaceWaterBodyIntercalibrationTypeCode =
      tidyr::replace_na(surfaceWaterBodyIntercalibrationTypeCode, "inapplicable")
  )

```

### C. Save combined EQS WISE4 & WISE2 data for WB and Cycle (means)
```{r save EQS WB Cycle TRaC waters}
dat_EQS_aggrWBCycles_ICtypes$Created <- Sys.Date()
write.xlsx(dat_EQS_aggrWBCycles_ICtypes,here("DataCreated","BQEdat-EQS_aggrWBCycles_ICtypes.xlsx"))

```

