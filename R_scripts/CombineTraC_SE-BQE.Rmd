---
title: "CombineTraC_SE-BQE"
author: "HT"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(openxlsx)
library(tidyverse)
library(dplyr)
library(tidyr)
```

This script joins the previously extracted water quality data (WQ from WISE-6) for selected supporting elements (SE) to the biological classifications (BQE from WISE-4 & WISE-2), for both TRaC water categories (TW & CW). 

* WQ(SE) - From WISE6, this script uses the previously source Site disaggregated SE data summarised (mean) by Year and Site and the source Site aggregated data by year, which are here merged before they are combined with BQE data.

* BQE - From WISE2, EQR & EQS aggregated by Site (yearly), except for EE, IE and SI for which only already aggregated data by WB was available at source, so the EQR & EQSaggWB data was also extracted (for all countries and for those 4 countries). Data was extracted for all years available until 2023.

* BQE - From WISE4, only WB aggregated EQS data (i.e., categories, not EQR) was available for the 1st and 2nd reporting cycle years 2010 and 2016.

## A. Import Water Quality Supporting Element data
### A1. Create a list of Supporting Elements (SE) determinand codes available per TraC water category
```{r Dets list per Water category}
#Create a list of determinand codes of interest
observedPropertyDeterminandCode <- c("EEA_3131-01-9","CAS_14797-55-8","EEA_3152-01-0","CAS_14797-65-0",
             "CAS_14798-03-9","CAS_14265-44-2","EEA_3132-01-2","EEA_3164-01-0",
             "EEA_3111-01-1","EEA_3141-01-3","EEA_31615-01-7","EEA_31-02-7",
             "CAS_7723-14-0","EEA_3133-05-9","EEA_3133-06-0","CAS_16887-00-6",
             "CAS_7664-41-7","EEA_3133-01-5","EEA_3112-01-4","EEA_3161-02-2",
             "EEA_31613-01-1","EEA_31-03-8","EEA_3161-05-5","EEA_3161-03-3",
             "EEA_3121-01-5","EEA_3161-04-4","EEA_3164-07-6","EEA_3153-02-4","EEA_3133-02-6")

observedPropertyDeterminandLabel <- c("Oxygen saturation","Nitrate","pH","Nitrite",
                                      "Ammonium","Phosphate","Dissolved oxygen",
                                      "Chlorophyll a","Secchi depth","Salinity",
                                      "Total nitrogen","Total suspended solids",
                                      "Total phosphorus","Dissolved organic carbon (DOC)",
                                      "Total organic carbon (TOC)","Chloride",
                                      "Ammonia","BOD5","Turbidity","Total oxidised nitrogen",
                                      "Non-ionised ammonia","Total dissolved solids",
                                      "Total inorganic nitrogen","Total organic nitrogen",
                                      "Water temperature", "Particulate organic nitrogen",
                                      "Total nitrogen to total phosphorus ratio","Alkalinity","BOD7")

# add an abbreviated name for convenience
Det <- c("DOpc","NO3","pH","NO2","NH4","PO4P","DO","CHLA","SD","SAL","TN","SS","TP","DOC",
         "TOC","Cl","NH3","BOD5","TURB","TON","NH3UI","TDS","TIN","TON","Temp","PON","TN:TP","Alk","BOD7")

resultUom <- c("%","mg{NO3}/L","[pH]","mg{NO2}/L","mg{NH4}/L","mg{P}/L","mg/L",
               "ug/L","m","{PSU}","mg{N}/L", "mg/L","mg{P}/L","mg{C}/L","mg{C}/L",
               "mg/L","ug/L","mg{O2}/L","{NTU}","mg{N}/L","mg{NH3}/L","mg/L",
               "mg{N}/L","mg{N}/L","Cel","mg{N}/L","{massRatio}","mg/L","mg{O2}/L")

# create data frame and rename columns
Determinands <- data.frame(observedPropertyDeterminandCode,observedPropertyDeterminandLabel,Det,resultUom)

#Save determinands used as rds file
saveRDS(Determinands,file = here("Data","Determinands_TRaC.rds")) #TRaC WQ sites
notes <- "Determinands extracted in extractWFDdata_WISE6_SE for TRaC waters. Database consulted November 2025. For further details see: https://discodata.eea.europa.eu and https://sdi.eea.europa.eu/catalogue/datahub/api/records/77976729-1aeb-4b61-a673-83db6c6a2ab2/formatters/xsl-view?output=pdf&language=eng&approved=true" 

writeLines(notes,here("Data","ReadMe_Determinands.txt"))


#Save determinands used as xlsx workbook
wb <- createWorkbook()
addWorksheet(wb,"dets")
addWorksheet(wb, "notes")
writeData(wb,"dets",Determinands,startRow = 1,startCol = 1)
writeData(wb,"notes",notes,startRow = 1,startCol = 1)
saveWorkbook(wb,file =here("Data","Determinands.xlsx"),overwrite = TRUE)
```

### A2. Import water quality (WQ) data from WISE6 on SE available for TraC Waters
```{r get TraC WQ data}
#import the SE WQ data for TRaC
WQdatTWSite <- readRDS(file = here("Data","dat_WQ_TW.rds")) #TW mean disaggSite
WQdatCWSite <- readRDS(file = here("Data","dat_WQ_CW.rds")) #CW mean disaggSite

WQdatTWSiteAgg <- readRDS(file = here("Data","dat_WQ_TWagg.rds")) #TW aggSite
WQdatCWSiteAgg <- readRDS(file = here("Data","dat_WQ_CWagg.rds")) #CW aggSite

#add Determinands short names in Det
Determinands <- read.xlsx(here("Data","Determinands.xlsx"),sheet = "dets")
Determinands.s<- Determinands %>% select(observedPropertyDeterminandLabel,Det)

WQdatTWSite <- WQdatTWSite %>% left_join(Determinands.s, by="observedPropertyDeterminandLabel") 
WQdatCWSite <- WQdatCWSite %>% left_join(Determinands.s, by="observedPropertyDeterminandLabel") 

WQdatTWSiteAgg <- WQdatTWSiteAgg %>% left_join(Determinands.s, by="observedPropertyDeterminandLabel") 
WQdatCWSiteAgg <- WQdatCWSiteAgg %>% left_join(Determinands.s, by="observedPropertyDeterminandLabel") 

#filter datasets by Det !=NA, for keeping selected SE 
#TW
WQdatTWSite %>% 
  filter(is.na(Det)) %>%
  count()

WQdatTWSiteAgg <- WQdatTWSiteAgg %>% 
  filter(!is.na(Det))

#CW
WQdatCWSite %>% 
  filter(is.na(Det)) %>%
  count()

WQdatCWSiteAgg <- WQdatCWSiteAgg %>% 
  filter(!is.na(Det))

names(WQdatTWSite)
names(WQdatCWSiteAgg)

#prepare to merge datsets
#1st modify col name "resultStdValue" change to "resultStandardDeviationValue" to have std names across datasets
WQdatTWSite <- WQdatTWSite %>% 
  rename(resultStandardDeviationValue = resultStdValue) #change name as in agg dataset

WQdatCWSite <- WQdatCWSite %>% 
  rename(resultStandardDeviationValue = resultStdValue) #change name as in agg dataset

# Extra names in TW & CW aggregatedBySite datasets
#"parameterSamplingPeriod","procedureLOQValue","resultQualityNumberOfSamplesBelowLOQ","resultQualityMinimumBelowLOQ","resultQualityMeanBelowLOQ","resultQualityMaximumBelowLOQ","resultQualityMedianBelowLOQ","resultMedianValue","procedureAnalyticalMethod","resultObservationStatus","remarks","metadata_beginLifeSpanVersion","metadata_statusCode","metadata_observationStatus","metadata_statements","UID"      

#retain in merge:
#"parameterSamplingPeriod","procedureLOQValue","resultQualityNumberOfSamplesBelowLOQ","resultMedianValue","remarks","metadata_statements"
```

### A3. Overview of countries & reporting years in each WQ dataset (disagg vs agg by Site)
```{r overview WQ per WaterCat}
#Countries
#TW
WQdatTWSite$countryCode %>% 
  unique() %>% 
  sort()
#only in Disagg:"BE" "EL" "IE" "LT" "LV" "PL" "PT"

WQdatTWSiteAgg $countryCode %>% 
  unique() %>% 
  sort()
#only in Agg: "MT" 
#in both datasets: "BG" "DE" "ES" "FR" "HR" "IT" "NL" "RO" "UK"

#CW
WQdatCWSite $countryCode %>% 
  unique() %>% 
  sort()
#only in Disagg:"EE" "EL" "HR" "LT" "MT" "NL" "PL" "PT" "SE" "SI"

WQdatCWSiteAgg$countryCode %>% 
  unique() %>% 
  sort()
#only in Agg:"LV"
#in both datasets:"ES" "IS" "IT" "NO" "UK"

#Country and year
WQdatTWSite %>% 
  select(countryCode,phenomenonTimeReferenceYear) %>% 
  group_by(countryCode,phenomenonTimeReferenceYear)%>%
  summarise (n())%>%
   ungroup() #e.g. of Bulgaria BG 2010-2022 (#samples 3,9,21 per year)

WQdatTWSiteAgg %>% 
  select(countryCode,phenomenonTimeReferenceYear) %>% 
  group_by(countryCode,phenomenonTimeReferenceYear)%>%
  summarise (n())%>%
   ungroup() #e.g. of Bulgaria BG 1992-2012 (#samples 41,56,106 per year)

# often different years - good to merge datatsets, handle duplicates afterwards for overlapping years

```

### A4. Combine disaggregated and aggregated WQ data by Site per year
```{r Combine disagg and agg WQ datasets}

# Extra names in TW & CW aggregatedBySite datasets to drop:
#"resultQualityMinimumBelowLOQ","resultQualityMeanBelowLOQ","resultQualityMaximumBelowLOQ","resultQualityMedianBelowLOQ","procedureAnalyticalMethod","resultObservationStatus","metadata_beginLifeSpanVersion","metadata_statusCode","metadata_observationStatus","UID" 

WQdatTWSiteAgg.sel <- WQdatTWSiteAgg %>% 
  select(-c(resultQualityMinimumBelowLOQ,resultQualityMeanBelowLOQ,
            resultQualityMaximumBelowLOQ,resultQualityMedianBelowLOQ,
            procedureAnalyticalMethod,resultObservationStatus,
            metadata_beginLifeSpanVersion,metadata_statusCode,
            metadata_observationStatus,UID))

WQdatCWSiteAgg.sel <- WQdatCWSiteAgg %>% 
  select(-c(resultQualityMinimumBelowLOQ,resultQualityMeanBelowLOQ,
            resultQualityMaximumBelowLOQ,resultQualityMedianBelowLOQ,
            procedureAnalyticalMethod,resultObservationStatus,
            metadata_beginLifeSpanVersion,metadata_statusCode,
            metadata_observationStatus,UID))

WQdatTWSite$parameterSampleDepth <- as.numeric(WQdatTWSite$parameterSampleDepth)
WQdatCWSite$parameterSampleDepth <- as.numeric(WQdatCWSite$parameterSampleDepth)

#add new variable to identify datasets source 
WQdatTWSite$source <- "WISE6 disaggregated by Site" 
WQdatCWSite$source <- "WISE6 disaggregated by Site"
WQdatTWSiteAgg.sel$source <- "WISE6 aggregated by Site"
WQdatCWSiteAgg.sel$source <- "WISE6 aggregated by Site"

WQdatTWSiteMeanYearly <- full_join(WQdatTWSite, WQdatTWSiteAgg.sel, suffix = c(".dis", ".agg")) #TW
WQdatCWSiteMeanYearly <- full_join(WQdatCWSite, WQdatCWSiteAgg.sel, suffix = c(".dis", ".agg")) #CW

#check duplicates (same site, year, det)
WQdatTWSiteMeanYearly %>% 
  group_by(monitoringSiteIdentifier,waterBodyIdentifier,phenomenonTimeReferenceYear,Det) %>%
  filter(n()>1) %>%
  ungroup() 

WQdatCWSiteMeanYearly %>% 
  group_by(monitoringSiteIdentifier,waterBodyIdentifier,phenomenonTimeReferenceYear,Det) %>%
  filter(n()>1) %>%
  ungroup()
```

```{r Save combined WQ disagg and agg datasets}
#Save combined WQ datasets
WQdatTWSiteMeanYearly$Created <- Sys.Date()
WQdatCWSiteMeanYearly$Created <- Sys.Date()

write.xlsx(WQdatTWSiteMeanYearly,here("DataCreated","WQdatTW_siteMean_year.xlsx")) #TW
write.xlsx(WQdatCWSiteMeanYearly,here("DataCreated","WQdatCW_siteMean_year.xlsx")) #CW
```

### A5. Combine WQ data at Water Body level per year
```{r Combine WQ at WB level}
#TW prepare for aggregation at WB level
list.1 <- WQdatTWSiteMeanYearly %>% 
  filter(is.na(waterBodyIdentifier)) %>% 
  select(monitoringSiteIdentifier) %>% 
  unique() # monitoringSiteIdentifier with NAs in waterBodyName n=75

list.2 <- WQdatTWSiteMeanYearly %>% 
  select(thematicIdIdentifier) %>% 
  unique() # thematicIdIdentifier equivalent to monitoring site with waterBodyIdentifier info

list.1 <- rename(list.1, thematicIdIdentifier = monitoringSiteIdentifier)
list.3 <- intersect(list.1, list.2) # monitoring site names in both lists n=45

#check - names in monitoringSiteIdentifier not in thematicIdIdentifier:
list.4 <- WQdatTWSiteMeanYearly %>% 
  filter(!monitoringSiteIdentifier %in% thematicIdIdentifier) %>%
  select(monitoringSiteIdentifier) %>%
  group_by(monitoringSiteIdentifier)%>%
  summarise (n())%>%
   ungroup() # n=30

  #1st build a check list of corresponding thematicIdIdentifier and waterBodyName
WBnamesTW <- WQdatTWSiteMeanYearly %>%  
  select(thematicIdIdentifier,thematicIdIdentifierScheme,waterBodyIdentifier)%>%
  filter(!is.na(waterBodyIdentifier)) %>%
  distinct() # n=790 

 #2nd complete missing waterBodyName using WBnamesTW list
WQdatTWSiteMeanYearly.wb <- WQdatTWSiteMeanYearly %>%
  left_join(WBnamesTW, by = c("monitoringSiteIdentifier" = "thematicIdIdentifier", "monitoringSiteIdentifierScheme" = "thematicIdIdentifierScheme")) %>% 
  mutate(waterBodyIdentifier = ifelse(is.na(waterBodyIdentifier.x),
                                waterBodyIdentifier.y,
                                waterBodyIdentifier.x)) %>%
  select(-waterBodyIdentifier.x,-waterBodyIdentifier.y) # Remove the extra columns from the join if desired

  #3rd check if missing waterBodyIdentifier remain 
WQdatTWSiteMeanYearly.wb %>% 
  filter(is.na(waterBodyIdentifier)) %>%
  select(monitoringSiteIdentifier) %>%
  group_by(monitoringSiteIdentifier)%>%
  summarise (n())%>%
   ungroup() # monitoringSiteIdentifier with NAs in waterBodyName n=30 remain

WQdatTW_aggWB_year <- WQdatTWSiteMeanYearly.wb %>%
  select(monitoringSiteIdentifier,monitoringSiteIdentifierScheme,
         observedPropertyDeterminandCode,observedPropertyDeterminandLabel,Det,procedureAnalysedMatrix,
         resultUom,phenomenonTimeReferenceYear,parameterSampleDepth,
         resultMeanValue,thematicIdIdentifierScheme,thematicIdIdentifier,countryCode,
         waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         metadata_versionId,source,parameterSamplingPeriod,Created) %>%
  group_by(countryCode,waterBodyIdentifier,Det,resultUom,procedureAnalysedMatrix,
           parameterSampleDepth,parameterSamplingPeriod,phenomenonTimeReferenceYear) %>%
  summarise(resultMeanValueWB = mean(resultMeanValue, na.rm=TRUE),
            resultStdValueWB = sd(resultMeanValue, na.rm=TRUE), # for data dispersion
            resultMinimumValueWB = min(resultMeanValue, na.rm=TRUE),
            resultMaximumValueWB = max(resultMeanValue, na.rm=TRUE),
            resultNumberOfSamplesWB = n())

# dropped: "parameterWaterBodyCategory", "resultStandardDeviationValue", "resultMinimumValue","resultMaximumValue","resultNumberOfSamples",           "lat","lon","procedureLOQValue" ,"resultQualityNumberOfSamplesBelowLOQ","resultMedianValue","remarks", "metadata_statements"                 

#TW prepare for aggregation at WB level
list.5 <- WQdatCWSiteMeanYearly %>% 
  filter(is.na(waterBodyIdentifier)) %>% 
  select(monitoringSiteIdentifier) %>% 
  unique() # monitoringSiteIdentifier with NAs in waterBodyName n=8

list.6 <- WQdatCWSiteMeanYearly %>% 
  select(thematicIdIdentifier) %>% 
  unique() # thematicIdIdentifier equivalent to monitoring site with waterBodyIdentifier info

list.5 <- rename(list.5, thematicIdIdentifier = monitoringSiteIdentifier)
list.7 <- intersect(list.5, list.6) # monitoring site names in both lists n=3

#check - names in monitoringSiteIdentifier not in thematicIdIdentifier:
list.8 <- WQdatCWSiteMeanYearly %>% 
  filter(!monitoringSiteIdentifier %in% thematicIdIdentifier) %>%
  select(monitoringSiteIdentifier) %>%
  group_by(monitoringSiteIdentifier)%>%
  summarise (n())%>%
   ungroup() # n=5

  #1st build a check list of corresponding thematicIdIdentifier and waterBodyName
WBnamesCW <- WQdatCWSiteMeanYearly %>%  
  select(thematicIdIdentifier,thematicIdIdentifierScheme,waterBodyIdentifier)%>%
  filter(!is.na(waterBodyIdentifier)) %>%
  distinct() # n=1364 

 #2nd complete missing waterBodyName using WBnamesTW list
WQdatCWSiteMeanYearly.wb <- WQdatCWSiteMeanYearly %>%
  left_join(WBnamesCW, by = c("monitoringSiteIdentifier" = "thematicIdIdentifier", "monitoringSiteIdentifierScheme" = "thematicIdIdentifierScheme")) %>% 
  mutate(waterBodyIdentifier = ifelse(is.na(waterBodyIdentifier.x),
                                waterBodyIdentifier.y,
                                waterBodyIdentifier.x)) %>%
  select(-waterBodyIdentifier.x,-waterBodyIdentifier.y) # Remove the extra columns from the join if desired

  #3rd check if missing waterBodyIdentifier remain 
WQdatCWSiteMeanYearly.wb %>% 
  filter(is.na(waterBodyIdentifier)) %>%
  select(monitoringSiteIdentifier) %>%
  group_by(monitoringSiteIdentifier)%>%
  summarise (n())%>%
   ungroup() # monitoringSiteIdentifier with NAs in waterBodyName n=5 remain

WQdatCW_aggWB_year <- WQdatCWSiteMeanYearly.wb %>%
  select(monitoringSiteIdentifier,monitoringSiteIdentifierScheme,
         observedPropertyDeterminandCode,observedPropertyDeterminandLabel,Det,procedureAnalysedMatrix,
         resultUom,phenomenonTimeReferenceYear,parameterSampleDepth,
         resultMeanValue,thematicIdIdentifierScheme,thematicIdIdentifier,countryCode,
         waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         metadata_versionId,source,parameterSamplingPeriod,Created) %>%
  group_by(countryCode,waterBodyIdentifier,Det,resultUom,procedureAnalysedMatrix,
           parameterSampleDepth,parameterSamplingPeriod,phenomenonTimeReferenceYear) %>%
  summarise(resultMeanValueWB = mean(resultMeanValue, na.rm=TRUE),
            resultStdValueWB = sd(resultMeanValue, na.rm=TRUE), # for data dispersion
            resultMinimumValueWB = min(resultMeanValue, na.rm=TRUE),
            resultMaximumValueWB = max(resultMeanValue, na.rm=TRUE),
            resultNumberOfSamplesWB = n())

# dropped: "parameterWaterBodyCategory", "resultStandardDeviationValue", "resultMinimumValue","resultMaximumValue","resultNumberOfSamples",           "lat","lon","procedureLOQValue" ,"resultQualityNumberOfSamplesBelowLOQ","resultMedianValue","remarks", "metadata_statements"    
```

```{r Save combined WQ at WB level}
#Save datasets
WQdatTW_aggWB_year$Created <- Sys.Date()
WQdatCW_aggWB_year$Created <- Sys.Date()

write.xlsx(WQdatTW_aggWB_year,here("DataCreated","WQdatTW_aggWBmean_year.xlsx")) #TW
write.xlsx(WQdatCW_aggWB_year,here("DataCreated","WQdatCW_aggWBmean_year.xlsx")) #CW
```

### A6. Combine WQ data for TW at Water Body level per Reporting cycle
```{r Define time periods for WFD reporting cycles}
#Consider the years in each WFD reporting cycle, e.g. [2010-2015] leading to the 2nd reporting cycle 2016
#define time periods:
periods <- list(
  "2000_2003" = c(2000, 2003),
  "2004_2009" = c(2004, 2009),
  "2010_2015" = c(2010, 2015),
  "2016_2021" = c(2016, 2021),
  ">2022" = c(2022, 2024)
)
```

TW
```{r WQ data summarised per WB-Cycle TW to wide}
#loop through periods and store results in named lists:
#TW
WQdatTWSite_Period <- list() # filtered site-year data
DetsTW.list_Period <- list()   # available determinands per period
WQ_TW_WBsummary_Period <- list()  # waterbody summaries per period
WQ_TWWB_wide  <- list()     # Waterbody WIDE format per period
WQ_TW_Duplicates_Period  <- list()   # duplicate detailed reporting

for (p in names(periods)) {
  
  years <- periods[[p]]
  
 message("\n-------------------------------------------")
  message("Processing period: ", p)
  message("-------------------------------------------")
  
  #filter to years in the period
  WQdatTWSite_Period[[p]] <- WQdatTWSite %>% 
    filter(phenomenonTimeReferenceYear >= years[1] &
           phenomenonTimeReferenceYear <= years[2])
  
  #extract available determinands for this period
  DetsTW.list_Period[[p]] <- unique(WQdatTWSite_Period[[p]]$Det) # list available dets
  
  #summaryse at WB level
  WQ_TW_WBsummary_Period[[p]] <- WQdatTWSite_Period[[p]] %>% 
    select(
      countryCode, waterBodyIdentifier, waterBodyName,
      observedPropertyDeterminandCode, observedPropertyDeterminandLabel,
      Det, resultUom, resultMeanValue, lat, lon,
      phenomenonTimeReferenceYear
    ) %>%
    group_by(
      countryCode, waterBodyIdentifier, waterBodyName,
      observedPropertyDeterminandCode, observedPropertyDeterminandLabel,
      Det, resultUom
    ) %>%
    summarise(
      wbMeanValue = mean(resultMeanValue, na.rm = TRUE),
      nSamples = n(),
      nYears = n_distinct(phenomenonTimeReferenceYear),
      latMean = mean(lat, na.rm = TRUE),
      lonMean = mean(lon, na.rm = TRUE),
      .groups = "drop" # safer than ungroup ()
    )
  
  #duplicate check (BEFORE pivot_wider)
  dupTW_summary <- WQ_TW_WBsummary_Period[[p]] %>%
    count(countryCode, waterBodyIdentifier, waterBodyName, Det) %>%
    filter(n > 1)
  
  if (nrow(dupTW_summary) > 0) {
    
    warning("\nDuplicates detected in period ", p, ":")
    print(dupTW_summary, n = Inf)
    
    # Extract full duplicate details with site info
    dupTW_details <- WQdatTWSite_Period[[p]] %>%
      semi_join(dupTW_summary,
        by = c("countryCode", "waterBodyIdentifier",
               "waterBodyName", "Det")
      ) %>%
      group_by(
        countryCode, waterBodyIdentifier, waterBodyName,
        Det
      ) %>%
      summarise(
        stations          = paste(unique(monitoringSiteIdentifier), collapse = ", "),
        schemes           = paste(unique(monitoringSiteIdentifierScheme), collapse=", "),
        years             = paste(sort(unique(phenomenonTimeReferenceYear)), collapse = ", "),
        nSamples_raw      = n(),
        meanValue_raw     = mean(resultMeanValue, na.rm = TRUE),
        min_raw           = min(resultMeanValue, na.rm = TRUE),
        max_raw           = max(resultMeanValue, na.rm = TRUE),
        raw_values        = paste(round(resultMeanValue, 3), collapse = ", "),
        .groups = "drop"
      )
    
    WQ_TW_Duplicates_Period[[p]] <- dupTW_details
    
  } else {
    message("No duplicates detected before pivot_wider.")
    WQ_TW_Duplicates_Period[[p]] <- data.frame()  # empty
  }
  #convert to WIDE format (no List cols)
   WQ_TWWB_wide[[p]] <-  WQ_TW_WBsummary_Period[[p]] %>% 
      select(
      -observedPropertyDeterminandCode,
      -observedPropertyDeterminandLabel,
      -resultUom,
      -nSamples,
      -latMean,
      -lonMean
    ) %>% 
    pivot_wider(
      names_from  = Det,
      values_from = wbMeanValue,
      values_fn   = mean
    ) %>% 
    rename_with(
      ~ paste0(.x, "_Mn"),
      any_of(DetsTW.list_Period[[p]])
    )
}

```
  
```{r WQ data WB-cycle TW inspect results}
#inspect period results
sort(unique(WQdatTWSite_Period$`2010_2015`$phenomenonTimeReferenceYear)) #years per period
head(WQ_TW_WBsummary_Period$`2010_2015`)
head(WQ_TWWB_wide$`2010_2015`)
```

```{r Excel Export of Duplicate Reports TW}
#each period gets its own sheet
wbTW <- createWorkbook()

for (p in names(WQ_TW_Duplicates_Period)) {
  addWorksheet(wbTW, sheetName = p)
  writeData(wbTW, p, WQ_TW_Duplicates_Period[[p]])
}

saveWorkbook(wbTW, here("DataCreated","WQ_TWWB_Duplicates_Report.xlsx"), overwrite = TRUE)

```

### A7. Combine WQ data for CW at Water Body level per Reporting cycle 
CW
```{r WQ data summarised per WB-Cycle TW to wide}
#loop through periods and store results in named lists:
#CW
WQdatCWSite_Period <- list() # filtered site-year data
DetsCW.list_Period <- list()   # available determinands per period
WQ_CW_WBsummary_Period <- list()  # waterbody summaries per period
WQ_CWWB_wide  <- list()     # Waterbody WIDE format per period
WQ_CW_Duplicates_Period  <- list()   # duplicate detailed reporting

for (p in names(periods)) {
  
  years <- periods[[p]]
  
 message("\n-------------------------------------------")
  message("Processing period: ", p)
  message("-------------------------------------------")
  
  #filter to years in the period
  WQdatCWSite_Period[[p]] <- WQdatCWSite %>% 
    filter(phenomenonTimeReferenceYear >= years[1] &
           phenomenonTimeReferenceYear <= years[2])
  
  #extract available determinands for this period
  DetsCW.list_Period[[p]] <- unique(WQdatCWSite_Period[[p]]$Det) # list available dets
  
  #summaryse at WB level
  WQ_CW_WBsummary_Period[[p]] <- WQdatCWSite_Period[[p]] %>% 
    select(
      countryCode, waterBodyIdentifier, waterBodyName,
      observedPropertyDeterminandCode, observedPropertyDeterminandLabel,
      Det, resultUom, resultMeanValue, lat, lon,
      phenomenonTimeReferenceYear
    ) %>%
    group_by(
      countryCode, waterBodyIdentifier, waterBodyName,
      observedPropertyDeterminandCode, observedPropertyDeterminandLabel,
      Det, resultUom
    ) %>%
    summarise(
      wbMeanValue = mean(resultMeanValue, na.rm = TRUE),
      nSamples = n(),
      nYears = n_distinct(phenomenonTimeReferenceYear),
      latMean = mean(lat, na.rm = TRUE),
      lonMean = mean(lon, na.rm = TRUE),
      .groups = "drop" # safer than ungroup ()
    )
  
  #duplicate check (BEFORE pivot_wider)
  dupCW_summary <- WQ_CW_WBsummary_Period[[p]] %>%
    count(countryCode, waterBodyIdentifier, waterBodyName, Det) %>%
    filter(n > 1)
  
  if (nrow(dupCW_summary) > 0) {
    
    warning("\nDuplicates detected in period ", p, ":")
    print(dupCW_summary, n = Inf)
    
    # Extract full duplicate details with site info
    dupCW_details <- WQdatCWSite_Period[[p]] %>%
      semi_join(dupCW_summary,
        by = c("countryCode", "waterBodyIdentifier",
               "waterBodyName", "Det")
      ) %>%
      group_by(
        countryCode, waterBodyIdentifier, waterBodyName,
        Det
      ) %>%
      summarise(
        stations          = paste(unique(monitoringSiteIdentifier), collapse = ", "),
        schemes           = paste(unique(monitoringSiteIdentifierScheme), collapse=", "),
        years             = paste(sort(unique(phenomenonTimeReferenceYear)), collapse = ", "),
        nSamples_raw      = n(),
        meanValue_raw     = mean(resultMeanValue, na.rm = TRUE),
        min_raw           = min(resultMeanValue, na.rm = TRUE),
        max_raw           = max(resultMeanValue, na.rm = TRUE),
        raw_values        = paste(round(resultMeanValue, 3), collapse = ", "),
        .groups = "drop"
      )
    
    WQ_CW_Duplicates_Period[[p]] <- dupCW_details
    
  } else {
    message("No duplicates detected before pivot_wider.")
    WQ_CW_Duplicates_Period[[p]] <- data.frame()  # empty
  }
  
  #convert to WIDE format (no List cols)
   WQ_CWWB_wide[[p]] <-  WQ_CW_WBsummary_Period[[p]] %>% 
      select(
      -observedPropertyDeterminandCode,
      -observedPropertyDeterminandLabel,
      -resultUom,
      -nSamples,
      -latMean,
      -lonMean
    ) %>% 
    pivot_wider(
      names_from  = Det,
      values_from = wbMeanValue,
      values_fn   = mean
    ) %>% 
    rename_with(
      ~ paste0(.x, "_Mn"),
      any_of(DetsCW.list_Period[[p]])
    )
}

```

```{r WQ data WB-cycle CW inspect results}
#inspect period results
sort(unique(WQdatCWSite_Period$`2010_2015`$phenomenonTimeReferenceYear)) #years per period
head(WQ_CW_WBsummary_Period$`2010_2015`)
head(WQ_CWWB_wide$`2010_2015`)

```

```{r Excel Export of Duplicate Reports CW}
#each period gets its own sheet
wbCW <- createWorkbook()

for (p in names(WQ_CW_Duplicates_Period)) {
  addWorksheet(wbCW, sheetName = p)
  writeData(wbCW, p, WQ_CW_Duplicates_Period[[p]])
}

saveWorkbook(wbCW, here("DataCreated","WQ_CWWB_Duplicates_Report.xlsx"), overwrite = TRUE)


```

### A8. Combine WQ data for TW & CW at Water Body level per Reporting cycle - MASTER datasets
TW
```{r WQ data WB-cycle combined wide-per period Table TW}
#1st force numeric columns so list-cols get reduced
WQ_TWWB_wide_clean <- lapply(WQ_TWWB_wide, function(df) {
  df %>% mutate(across(where(is.list), ~sapply(.x, function(v) mean(unlist(v), na.rm=TRUE))))
})

#Change units of P data to micrograms/L in WB-cycle combined datasets
WQ_TWWB_wide_clean <- lapply(
  WQ_TWWB_wide_clean,
  function(df) {
    df %>% mutate(
      TP_Mn_microgr   = if ("TP_Mn"   %in% names(df)) TP_Mn   * 1000 else NA_real_,
      PO4P_Mn_microgr = if ("PO4P_Mn" %in% names(df)) PO4P_Mn * 1000 else NA_real_
    )
  }
)

WQ_TWWB_master_list <- WQ_TWWB_wide_clean #Keep the list of period tables for Excel export

#create one combined long master table
WQ_TWWB_master_df <- bind_rows(
  lapply(names(WQ_TWWB_wide_clean), function(p) {
    WQ_TWWB_wide_clean[[p]] %>% mutate(Period = p)
  }),
  .id = NULL
) %>% relocate(Period, .before = 1) # put Period as first column

head(WQ_TWWB_master_df) #check
```

CW
```{r WQ data WB-cycle combined wide-per period Table CW}
#1st force numeric columns so list-cols get reduced
WQ_CWWB_wide_clean <- lapply(WQ_CWWB_wide, function(df) {
  df %>% mutate(across(where(is.list), ~sapply(.x, function(v) mean(unlist(v), na.rm=TRUE))))
})

#Change units of P data to micrograms/L in WB-cycle combined datasets
WQ_CWWB_wide_clean <- lapply(
  WQ_CWWB_wide_clean,
  function(df) {
    df %>% mutate(
      TP_Mn_microgr   = if ("TP_Mn"   %in% names(df)) TP_Mn   * 1000 else NA_real_,
      PO4P_Mn_microgr = if ("PO4P_Mn" %in% names(df)) PO4P_Mn * 1000 else NA_real_
    )
  }
)

WQ_CWWB_master_list <- WQ_CWWB_wide_clean #Keep the list of period tables for Excel export

#create one combined long master table
WQ_CWWB_master_df <- bind_rows(
  lapply(names(WQ_CWWB_wide_clean), function(p) {
    WQ_CWWB_wide_clean[[p]] %>% mutate(Period = p)
  }),
  .id = NULL
) %>% relocate(Period, .before = 1) # put Period as first column


head(WQ_CWWB_master_df) #check
```

### A9. Check units of P data to micrograms/L in WB-cycle combined datasets 
```{r WQ data change units TW }
# CHECK units of P data to micrograms/L (keep both columns mg/L and ug/L versions)
summary(WQ_TWWB_master_df)
```

```{r WQ data change units CW}
# CHECK units of P data to micrograms/L (keep both mg/L and ug/L versions)
summary(WQ_CWWB_master_df)
```

### A10. Export WB-cycle combined datasets to Excel multi-sheet files
```{r WQ data WB-cycle combined save Excel multi-sheet period}
#1st apply function to sanitize sheet names:
clean_sheet_name <- function(x) {
  x <- gsub("[:\\\\/?*\\[\\]<>]", "_", x)   # replace illegal chars
  x <- trimws(x)                            # remove leading/trailing spaces
  x <- substr(x, 1, 31)                     # Excel max = 31 chars
  return(x)
}


#TW
wbTWWB <- createWorkbook()

for (p in names(WQ_TWWB_master_list)) {
  
  sheet <- clean_sheet_name(p)
  message("Adding sheet: ", sheet, "  (from original: ", p, ")")
  
  addWorksheet(wbTWWB, sheetName = sheet)
  writeData(wbTWWB, sheet = sheet, x = WQ_TWWB_master[[p]])
}

saveWorkbook(wbTWWB, here("DataCreated","WQ_TWWBsummary_Periods.xlsx"), overwrite = TRUE)

#CW 
wbCWWB <- createWorkbook()

for (p in names(WQ_CWWB_master_list)) {
  
  sheet <- clean_sheet_name(p)
  
  addWorksheet(wbCWWB, sheetName = sheet)
  writeData(wbCWWB, sheet = sheet, x = WQ_CWWB_master[[p]])
}

saveWorkbook(wbCWWB, here("DataCreated","WQ_CWWBsummary_Periods.xlsx"), overwrite = TRUE)

```

**Plots for checking weird values**
Some P data seems to have has been reported in the wrong units (ug/L) rather than the stated (mg/L). Unsure - check with old reports and MS. Focus on the parameters to be used for BPG approaches testing: e.g. TN, NO3, Secchi Depth and Dissolved Oxygen
```{r SE check plots}
#CW
ggplot(WQ_CWWB_master_df, aes(x=as.factor(countryCode),y=PO4P_Mn)) +
  geom_boxplot()

ggplot(WQ_CWWB_master_df, aes(x=as.factor(countryCode),y=PO4P_Mn_microgr)) +
  geom_boxplot()

ggplot(WQ_CWWB_master_df, aes(x=as.factor(countryCode),y=SD_Mn)) +
  geom_boxplot()

```

## B. Import Biological QE data
### B1. Import BQE data for TraC Waters per year
```{r Import WISE4 Biota EQS classifications to Wide format}
#data split at Water Body level considering the years ]2009, 2016] leading to the 2nd reporting cycle 2016

#TW
dat_WFD_TW <- readRDS(here("Data","dat_W4_TW_BQE.rds")) #import biology

#check available reporting years
unique(dat_WFD_TW$cYear) # 2010, 2016

#all years
dat_WFD_TW.wide <- dat_WFD_TW %>% 
  select(euSurfaceWaterBodyCode,countryCode,qeCode,qeStatusOrPotentialValue,cYear,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode,cArea,cLength) %>% 
  pivot_wider(names_from = qeCode, values_from = qeStatusOrPotentialValue)

colnames(dat_WFD_TW.wide) <- make.names(names(dat_WFD_TW.wide)) # create valid names

#select only 2nd cycle assessments 2016
dat_WFD_TW_2nd <- dat_WFD_TW %>% 
  filter(cYear==2016) %>% 
  #filter(StartYear > 2009 |is.na(StartYear)) %>% 
  ungroup()

dat_WFD_TW_2nd_wide <- dat_WFD_TW_2nd %>% 
  select(euSurfaceWaterBodyCode,countryCode,qeCode,qeStatusOrPotentialValue,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode,cArea,cLength) %>% 
  pivot_wider(names_from = qeCode, values_from = qeStatusOrPotentialValue)

colnames(dat_WFD_TW_2nd_wide) <- make.names(names(dat_WFD_TW_2nd_wide)) # create valid names

#CW
dat_WFD_CW <- readRDS(here("Data","dat_W4_CW_BQE.rds")) #import biology

#check available reporting years
unique(dat_WFD_CW$cYear) # 2010, 2016

#all years
dat_WFD_CW.wide <- dat_WFD_CW %>% 
  select(euSurfaceWaterBodyCode,countryCode,qeCode,qeStatusOrPotentialValue,cYear,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode,cArea,cLength) %>% 
  pivot_wider(names_from = qeCode, values_from = qeStatusOrPotentialValue)

colnames(dat_WFD_CW.wide) <- make.names(names(dat_WFD_CW.wide)) # create valid names

#select only 2nd cycle assessments 2016
dat_WFD_CW_2nd <- dat_WFD_CW %>% 
  filter(cYear==2016) %>% 
  #filter(StartYear > 2009 |is.na(StartYear)) %>% 
  ungroup()

dat_WFD_CW_2nd_wide <- dat_WFD_CW_2nd %>% 
  select(euSurfaceWaterBodyCode,countryCode,qeCode,qeStatusOrPotentialValue,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         surfaceWaterBodyIntercalibrationType,surfaceWaterBodyIntercalibrationTypeCode,cArea,cLength) %>% 
  pivot_wider(names_from = qeCode, values_from = qeStatusOrPotentialValue)

colnames(dat_WFD_CW_2nd_wide) <- make.names(names(dat_WFD_CW_2nd_wide)) # create valid names
```

```{r Import WISE2 Biota EQS classifications to Wide format}
#TW & CW SiteMean per year all period of data
dat_BQE_TW <- readRDS(here("Data","dat_BQE_TW.rds")) #import biology
dat_BQE_CW <- readRDS(here("Data","dat_BQE_CW.rds")) #import biology

#TRaC aggregated by WB per year all period of data
dat_BQE_TRaC.aggrWB <- readRDS(here("Data","dat_BQE_TRaC_aggrWB_all.rds")) #import biology aggregated by WB all years 

#TW
names(dat_BQE_TW)

dat_BQE_TW_wideEQS <- dat_BQE_TW %>% 
  select(countryCode,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         monitoringSiteIdentifier,monitoringSiteIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, 
              values_from = resultEcologicalStatusClassValue,
              values_fn = mean)   #how to combine duplicates

colnames(dat_BQE_TW_wideEQS) <- make.names(names(dat_BQE_TW_wideEQS)) # create valid names


#CW
dat_BQE_CW_wideEQS <- dat_BQE_CW %>% 
  select(countryCode,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         monitoringSiteIdentifier,monitoringSiteIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, 
              values_from = resultEcologicalStatusClassValue,
              values_fn = mean)

colnames(dat_BQE_CW_wideEQS) <- make.names(names(dat_BQE_CW_wideEQS)) # create valid names

#TRaC aggWB
dat_BQE_TRaC.aggrWB_wideEQS <- dat_BQE_TRaC.aggrWB %>% 
  select(countryCode,parameterWaterBodyCategory,waterBodyIdentifier,waterBodyName,parameterNCSWaterBodyType,
         waterBodyIdentifierScheme,parameterNaturalAWBHMWB,
         phenomenonTimeReferenceYear,observedPropertyDeterminandLabel,resultEcologicalStatusClassValue) %>% 
  pivot_wider(names_from = observedPropertyDeterminandLabel, values_from = resultEcologicalStatusClassValue)

colnames(dat_BQE_TRaC.aggrWB_wideEQS) <- make.names(names(dat_BQE_TRaC.aggrWB_wideEQS)) # create valid names

```

### B2. Combine WISE4 & WISE2 Biological EQS data for all available years
```{r harmonise BQEs names WISE2 & WISE4}
#wise4
dat_WFD_TW.wide #n=1119
dat_WFD_CW.wide #n=4735

#wise2
dat_BQE_TW_wideEQS #n=1496
dat_BQE_CW_wideEQS #n=3257
dat_BQE_TRaC.aggrWB_wideEQS #n=1451

#1st harmonise BQE names in both reporting databases 
names(dat_WFD_TW.wide)
names(dat_WFD_CW.wide)
names(dat_BQE_TW_wideEQS)
names(dat_BQE_CW_wideEQS)
names(dat_BQE_TRaC.aggrWB_wideEQS)

#TW 
dat_WFD_TW.wide <- dat_WFD_TW.wide %>%
  rename(
    InvertebrateEQR = QE1.3...Benthic.invertebrates,
    FishEQR = QE1.4...Fish,
    MacroalgaeEQR = QE1.2.1...Macroalgae,
    PhytoplanktonEQR = QE1.1...Phytoplankton,
    otherAquaticFlora = QE1.2...Other.aquatic.flora,
    Macrophytes = QE1.2.3...Macrophytes,
    AngiospermsEQR = QE1.2.2...Angiosperms,
    PhytobenthosEQR_E = QE1.2.4...Phytobenthos
  )

#CW
dat_WFD_CW.wide <- dat_WFD_CW.wide %>%
  rename(
    InvertebrateEQR = QE1.3...Benthic.invertebrates,
    FishEQR = QE1.4...Fish,
    MacroalgaeEQR = QE1.2.1...Macroalgae,
    PhytoplanktonEQR = QE1.1...Phytoplankton,
    otherAquaticFlora = QE1.2...Other.aquatic.flora,
    Macrophytes = QE1.2.3...Macrophytes,
    AngiospermsEQR = QE1.2.2...Angiosperms,
    PhytobenthosEQR_E = QE1.2.4...Phytobenthos
  )

```

```{r prepare data to merge BQE aggrWB from WISE2 & WISE4 }
#1st check for differences in variables names in wise 4 TW vs CW
setdiff(names(dat_WFD_TW.wide),names(dat_WFD_CW.wide)) #no difference between TW & CW WISE4

#2nd merge TW and CW in WISE4 into unique df
dat_WFD_TRaC.aggrWB_wideEQS <- bind_rows(TW = dat_WFD_TW.wide, CW = dat_WFD_CW.wide, 
                                         .id = "parameterWaterBodyCategory") #id source water category dataset

#3rd inspect WISE4 vs WISE2 TRaC aggregated by WB
names(dat_WFD_TRaC.aggrWB_wideEQS) #WISE4
names(dat_BQE_TRaC.aggrWB_wideEQS) #WISE2

intersect(names(dat_WFD_TRaC.aggrWB_wideEQS),names(dat_BQE_TRaC.aggrWB_wideEQS)) 
#equal variable names to match:
#"parameterWaterBodyCategory" "countryCode" 
#"InvertebrateEQR"  "FishEQR"    "MacroalgaeEQR"    "PhytoplanktonEQR" "AngiospermsEQR" 

symdiff(names(dat_WFD_TRaC.aggrWB_wideEQS),names(dat_BQE_TRaC.aggrWB_wideEQS))
#equivalent variables to match:
#"naturalAWBHMWB" =  "parameterNaturalAWBHMWB" 
#"euSurfaceWaterBodyCode" = "waterBodyIdentifier"
#"surfaceWaterBodyTypeCode" = "parameterNCSWaterBodyType"

#missing BQEs to include 
# "PhytobenthosEQR_E", "otherAquaticFlora", "Macrophytes"    

#diff vars ADD:
#"phenomenonTimeReferenceYear" ,  "cYear"  
#"waterBodyName", "surfaceWaterBodyIntercalibrationType","surfaceWaterBodyIntercalibrationTypeCode"

#diff vars DROP:
unique(dat_BQE_TRaC.aggrWB_wideEQS$waterBodyIdentifierScheme)     
# waterBodyIdentifierScheme : in wise 2 
# -cArea, -cLength : in wise 4

dat_WFD_TRaC.aggrWB_wideEQS <- dat_WFD_TRaC.aggrWB_wideEQS %>% #WISE4 clean
  select(-cArea, -cLength) 

# WISE2 clean data and aggregate by WFD Cycle BEFORE merge with WISE4
# add WFD Cycle year variable to wise 2 "cYear"
cYear <- list(
  `baseline`= 2000:2003,
  `2010` = 2004:2009,
  `2016` = 2010:2015,
  `2022` = 2016:2021,
  `2028` = 2022:2027
)

dat_BQE_TRaC.aggrWB_Cycle <- dat_BQE_TRaC.aggrWB_wideEQS %>% # wise2
  select(-waterBodyIdentifierScheme) %>%
  mutate(cYear=case_when(
    phenomenonTimeReferenceYear %in% cYear$baseline ~ 2000,
    phenomenonTimeReferenceYear %in% cYear$`2010` ~ 2010,
    phenomenonTimeReferenceYear %in% cYear$`2016` ~ 2016,
    phenomenonTimeReferenceYear %in% cYear$`2022` ~ 2022,
    phenomenonTimeReferenceYear %in% cYear$`2028` ~ 2028,
    TRUE ~ NA_real_
    )
    )

names(dat_BQE_TRaC.aggrWB_Cycle)

#4th summarise WISE2 BQE EQS data per per WB and WFD cycle
#to include mean EQS value rounded per BQE + count samples
meanEQS_TRaC_Cycle_WB_wise2 <- dat_BQE_TRaC.aggrWB_Cycle %>%
  group_by(parameterWaterBodyCategory, cYear, countryCode, parameterNCSWaterBodyType, waterBodyIdentifier, waterBodyName,parameterNaturalAWBHMWB) %>%
  summarise(
    # mean values for all EQS rounded to nearest integer, then clipped to 1â€“5 scale
    across(
      ends_with("EQR"),
      ~ {
        m <- mean(.x, na.rm = TRUE)
        if (is.nan(m)) return(NA_real_)     # keep NA
        m_round <- round(m, 0)
        m_safe  <- min(max(m_round, 1), 5) # force between 1 and 5
        m_safe
      },
      .names = "{.col}_mean"
    ),
    
    # count of non-missing records per EQS value
    across(
      ends_with("EQR"),
      ~ sum(!is.na(.x)),
      .names = "{.col}_n"
    ),
    
    .groups = "drop"
  )



#5th join tables WISE4 vs WISE2 TRaC aggregated by WB
names (meanEQS_TRaC_Cycle_WB_wise2) #WISE2
names(dat_WFD_TRaC.aggrWB_wideEQS) #WISE4

meanEQS_TRaC_Cycle_WB_wise2_clean<- meanEQS_TRaC_Cycle_WB_wise2 %>% 
  select(-PhytoplanktonEQR_n, -MacroalgaeEQR_n, -InvertebrateEQR_n, -AngiospermsEQR_n, -FishEQR_n) #drop count of samples to mean EQS in WISE2

symdiff(names(meanEQS_TRaC_Cycle_WB_wise2_clean),names(dat_WFD_TRaC.aggrWB_wideEQS)) #check all vars not shared between WISE4 & WISE2
 
  
```

```{r merge WISE4 & WISE2 TRaC aggregated by WB and per Cycle}
 
#merge WISE4 & WISE2 TRaC aggregated by WB full_join to keep all data
  dat_EQS_aggrWB_since2010  <- full_join(meanEQS_TRaC_Cycle_WB_wise2_clean, dat_WFD_TRaC.aggrWB_wideEQS,
          by=c("parameterWaterBodyCategory",
               "cYear",
               "countryCode",
               "waterBodyIdentifier"="euSurfaceWaterBodyCode", #establish equivalence where names differ
               "parameterNCSWaterBodyType"="surfaceWaterBodyTypeCode",
               "parameterNaturalAWBHMWB"="naturalAWBHMWB",
               "PhytoplanktonEQR_mean"="PhytoplanktonEQR",
               "MacroalgaeEQR_mean"="MacroalgaeEQR",
               "InvertebrateEQR_mean"="InvertebrateEQR",
               "AngiospermsEQR_mean" = "AngiospermsEQR",
               "FishEQR_mean"="FishEQR"
               )
  )
  
  #rename variables for accuracy, EQS not EQR
  dat_EQS_aggrWB_since2010 <- dat_EQS_aggrWB_since2010 %>%
    rename( 
    "PhytoplanktonEQS"="PhytoplanktonEQR_mean",
    "MacroalgaeEQS"="MacroalgaeEQR_mean",
    "InvertebrateEQS"="InvertebrateEQR_mean",
    "AngiospermsEQS"="AngiospermsEQR_mean",
    "FishEQS"="FishEQR_mean",
    "otherAquaticFloraEQS"="otherAquaticFlora",
    "MacrophytesEQS"= "Macrophytes",
    "PhytobenthosE_EQS"="PhytobenthosEQR_E"
  )
  
 #checks
 length(unique(dat_EQS_aggrWB_since2010$surfaceWaterBodyIntercalibrationTypeCode))
 unique(dat_EQS_aggrWB_since2010$surfaceWaterBodyIntercalibrationTypeCode)
 
 #RW observations misclassified as CW, dropped
    dat_EQS_aggrWB_since2010 <- dat_EQS_aggrWB_since2010 %>%
      filter(!surfaceWaterBodyIntercalibrationTypeCode %in% c("RW-R-M4", "RW-R-M1"))

#fill in missing ICtype code for  WISE2 periods using WISE4 available IC common Types codes per water body
    dat_EQS_aggrWB_since2010_ICtypes <- dat_EQS_aggrWB_since2010 %>%
  group_by(waterBodyIdentifier) %>%
  # Fill missing codes using available IC TypeCode for the same water body
  mutate(
    surfaceWaterBodyIntercalibrationTypeCode = 
      if_else(
        is.na(surfaceWaterBodyIntercalibrationTypeCode),
        first(na.omit(surfaceWaterBodyIntercalibrationTypeCode)),
        surfaceWaterBodyIntercalibrationTypeCode
      )
  ) %>%
  ungroup()
   
#check
dat_EQS_aggrWB_since2010_ICtypes %>% 
      group_by(waterBodyIdentifier,surfaceWaterBodyIntercalibrationTypeCode,cYear) %>%
    summarise(n=n(), .groups = "drop")%>%
      arrange(desc(cYear), desc(n))
```

## C. Combine WFD TraC Supporting and Biological QE data
### C1. Combine WQ and BQE data for TraC Waters
Data averaged by Site and year - INCOMPLETE
```{r WQ SiteMean-Yearly to Wide format - INCOMPLETE}
# #TW
# Det.TW <- levels(factor(WQdatTWSiteMeanYearly.wb$Det))
# 
# WQdatTWSiteMeanYearly.wb <- WQdatTWSiteMeanYearly.wb %>%
#   mutate(phenomenonTimeReferenceYear = as.integer(round(phenomenonTimeReferenceYear)))
# 
# WQdatTWSiteMeanYearly.wide <- WQdatTWSiteMeanYearly.wb %>%
#   select(countryCode,monitoringSiteIdentifier,monitoringSiteIdentifierScheme,phenomenonTimeReferenceYear,Det,
#          resultMeanValue,procedureAnalysedMatrix,parameterSampleDepth,parameterSamplingPeriod,
#          waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,Created) %>%
#    pivot_wider(names_from = Det, values_from = resultMeanValue )  %>% 
#    rename_with(~paste0(.x,"_Mn"),any_of(Det.TW))#all_of(Det.TW)
# 
#CW
#import data
BQEdat <-"/Users/helianateixeira/Rdir/WFD-TRaC-data-upto2022/DataCreated/BQEdatCW_siteMean_year_wise2.xlsx"
SEdat <- "/Users/helianateixeira/Rdir/WFD-TRaC-data-upto2022/DataCreated/WQdatCW_siteMean_year.xlsx"
Dets <- "/Users/helianateixeira/Rdir/WFD-TRaC-data-upto2022/Data/Determinands.xlsx"

BQEsiteMnYr <- read.xlsx(BQEdat) #here("DataCreated","BQEdatCW_siteMean_year_wise2.xlsx")
SEsiteMnYr <- read.xlsx(SEdat) #here("DataCreated","WQdatCW_siteMean_year.xlsx")
Dets <- read.xlsx(Dets) #here("Data","Determinands.xlsx")
  #levels(factor(WQdatCWSiteMeanYearly.wb$Det))
# 
# WQdatCWSiteMeanYearly.wb <- WQdatCWSiteMeanYearly.wb %>%
#   mutate(phenomenonTimeReferenceYear = as.integer(round(phenomenonTimeReferenceYear)))
# 
# WQdatCWSiteMeanYearly.wide <- WQdatCWSiteMeanYearly.wb %>%
#   select(countryCode,monitoringSiteIdentifier,monitoringSiteIdentifierScheme,phenomenonTimeReferenceYear,Det,
#          resultMeanValue,procedureAnalysedMatrix,parameterSampleDepth,parameterSamplingPeriod,
#          waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,Created) %>%
#    pivot_wider(names_from = Det, values_from = resultMeanValue )  %>% 
#    rename_with(~paste0(.x,"_Mn"),any_of(Det.CW))#all_of(Det.TW)

```

```{r Combine WQ and EQS classifications per Site-Year - INCOMPLETE}
# 
# #wise6
# WQdatTWSiteMeanYearly.wide
# WQdatCWSiteMeanYearly.wide 
# 
# 
# 
# #Not Working:
# 
# # BQE_wide.testNames <- inner_join(
# #   dat_WFD_TW.wide,
# #   dat_BQE_TW_wideEQS,
# #   by = c("countryCode",
# #     "euSurfaceWaterBodyCode" = "waterBodyIdentifier",
# #     "surfaceWaterBodyTypeCode" = "parameterNCSWaterBodyType",
# #     "cYear" = "phenomenonTimeReferenceYear",
# #     "naturalAWBHMWB" = "parameterNaturalAWBHMWB"
# #   ))
# 
# 
# 
#   # QE1-1 - Phytoplankton	QE1-2 - Other aquatic flora	QE1-2-1 - Macroalgae	QE1-2-2 - Angiosperms	QE1-2-3 - Macrophytes	QE1-2-4 - Phytobenthos	QE1-3 - Benthic invertebrates	QE1-4 - Fish
#   
# 
# 
# 
# 
# #2nd merge Biology and SE
# #TW
# BQE-SE.TWsite <- inner_join(BQE_wide,WQ_wide, by = c(monitoringSiteIdentifier,monitoringSiteIdentifierScheme))
# 
# #CW
# 
# #ADAPT code below
# # notes <- "2nd cycle (2016) WFD classification (WISE4) linked by WB to WISE6 SoE WQ data (2010-2015) averaged by WB for TW. Created in CombineTraC_SE-BQE.Rmd"
# # writeLines(notes,here("DataCreated","BQESEdatTW_WFD2016_ReadMe.txt"))
# # 
# # #Save determinands used as xlsx workbook
# # wb <- createWorkbook()
# # addWorksheet(wb,"data")
# # addWorksheet(wb, "notes")
# # writeData(wb,"data",BQESEdatTW_WFD2016,startRow = 1,startCol = 1)
# # writeData(wb,"notes",notes,startRow = 1,startCol = 1)
# # saveWorkbook(wb,file =here("DataCreated","BQESEdatTW_WFD2016.xlsx"),overwrite = TRUE)
```

Data averaged by WB and Reporting Cycle - DONE!
```{r prepapre to combine WQ and EQS classifications WB-Cycle}
#prepare dfs for merge per WFD Cycle
#TW
BQE_TWWB_Cycle <- dat_EQS_aggrWB_since2010_ICtypes%>%filter(parameterWaterBodyCategory=="TW")
WQ_TWWB_Cycle <- WQ_TWWB_master_df
#CW
BQE_CWWB_Cycle <- dat_EQS_aggrWB_since2010_ICtypes %>%filter(parameterWaterBodyCategory=="CW")
WQ_CWWB_Cycle <- WQ_CWWB_master_df

# add WFD Cycle cYear to replace period in WQ data using values previously created
cYear #check list

unique(WQ_TWWB_Cycle$Period) #check periods to match cYear
#"2000_2003" "2004_2009" "2010_2015" "2016_2021" ">2022"   

#TW
WQ_TWWB_Cycle <- WQ_TWWB_Cycle %>%
  mutate(cYear=case_when(
    Period == "2000_2003" ~ 2000,
    Period == "2004_2009" ~ 2010,
    Period == "2010_2015" ~ 2016,
    Period == "2016_2021" ~ 2022,
    Period == ">2022" ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-Period)

WQ_TWWB_Cycle_clean <- WQ_TWWB_Cycle %>%  select(-nYears)


#CW
WQ_CWWB_Cycle <- WQ_CWWB_Cycle %>% 
  mutate(cYear=case_when(
    Period == "2000_2003" ~ 2000,
    Period == "2004_2009" ~ 2010,
    Period == "2010_2015" ~ 2016,
    Period == "2016_2021" ~ 2022,
    Period == ">2022" ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-Period)


WQ_CWWB_Cycle_clean <- WQ_CWWB_Cycle %>%  select(-nYears)

#inspect variables in both dfs before merge
symdiff(names(BQE_TWWB_Cycle),names(WQ_TWWB_Cycle_clean))
intersect(names(BQE_TWWB_Cycle),names(WQ_TWWB_Cycle_clean))

#drop "parameterWaterBodyCategory" var BQE data:
BQE_TWWB_Cycle_clean <- BQE_TWWB_Cycle %>%
  select(-parameterWaterBodyCategory)

BQE_CWWB_Cycle_clean <- BQE_CWWB_Cycle %>%
  select(-parameterWaterBodyCategory)
 
#TW
BQE_waterbodiesTW <- list(unique(BQE_TWWB_Cycle_clean$waterBodyIdentifier))
SE_waterbodiesTW <- list(unique(WQ_TWWB_Cycle_clean$waterBodyIdentifier))
length(intersect(BQE_waterbodiesTW[[1]],SE_waterbodiesTW[[1]])) #check common WBs n=273

#CW 
BQE_waterbodiesCW <- list(unique(BQE_CWWB_Cycle_clean$waterBodyIdentifier))
SE_waterbodiesCW <- list(unique(WQ_CWWB_Cycle_clean$waterBodyIdentifier))
length(intersect(BQE_waterbodiesCW[[1]],SE_waterbodiesCW[[1]])) #check common WBs n=360
```

### C2. Final merge WQ and BQE data per WB and Reporting Cycle
```{r Final merge WQ and BQE data per WB-Cycle}
#merge Biology and SE using inner_join to keep only BQE observations that have corresponding data in WQ

#1st before joining checka for and summarise any duplicates
#WQ dat
WQ_TWWB_unique <- WQ_TWWB_Cycle_clean %>%
  group_by(countryCode, waterBodyIdentifier, cYear) %>%
  summarise(across(ends_with("_Mn"), ~ mean(.x, na.rm = TRUE)),
            across(-ends_with("_Mn"), ~ dplyr::first(.x)),
            .groups = "drop")

WQ_CWWB_unique <- WQ_CWWB_Cycle_clean %>%
  group_by(countryCode, waterBodyIdentifier, cYear) %>%
  summarise(across(ends_with("_Mn"), ~ mean(.x, na.rm = TRUE)),
            across(-ends_with("_Mn"), ~ dplyr::first(.x)),
            .groups = "drop")

#BQE dat
BQE_TWWB_unique <- BQE_TWWB_Cycle_clean %>%
  group_by(countryCode, waterBodyIdentifier, cYear) %>%
  summarise(across(contains("EQS"), ~ mean(.x, na.rm = TRUE)),
            across(-contains("EQS"), ~ dplyr::first(.x)),
            .groups = "drop")

BQE_CWWB_unique <- BQE_CWWB_Cycle_clean %>%
  group_by(countryCode, waterBodyIdentifier, cYear) %>%  
  summarise(across(contains("EQS"), ~ mean(.x, na.rm = TRUE)),
            across(-contains("EQS"), ~ dplyr::first(.x)),
            .groups = "drop")
    
  
#2nd join BQE and WQ data
#TW
BQESE.TW <- inner_join(
  BQE_TWWB_unique,
  WQ_TWWB_unique,
  by = c("waterBodyIdentifier", "cYear", "countryCode")) %>%
 mutate(DateCreated = Sys.time())

#order df variables :
BQESE.TW <- BQESE.TW %>%
  rename(
    waterBodyName.WISEbio = waterBodyName.x,
    waterBodyName.WISEse  = waterBodyName.y
  ) %>%
  select(
    cYear, countryCode, parameterNaturalAWBHMWB, 
    waterBodyIdentifier, waterBodyName.WISEbio, waterBodyName.WISEse,
    parameterNCSWaterBodyType, surfaceWaterBodyIntercalibrationType,
    surfaceWaterBodyIntercalibrationTypeCode,
    matches("EQS") %>% sort(), # all columns containing "EQS", alphabetical
    matches("_Mn") %>% sort(),  # all columns containing "_Mn", alphabetical
    "DateCreated", # last column
    everything()
  )

# --- Function to clean NA for Excel ---
fix_excel_na <- function(df) {
  df %>%
    mutate(across(where(is.numeric),
                  ~ ifelse(is.na(.x), "", .x)))
}


notes <- "All cycles WFD TW EQS classifications (WISE4&2) aggr by WB and WFD Cycle to WISE6 SoE WQ data averaged by WB and Cycle. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes,here("DataCreated","BQESEdatTW_WFDallCycles_ReadMe.txt"))

#Save BQE-SE combined data as xlsx workbook
wbAllTW_WB <- createWorkbook()

addWorksheet(wbAllTW_WB,"data")
addWorksheet(wbAllTW_WB, "notes")

# Clean NA before writing
BQESE.TW_export <- fix_excel_na(BQESE.TW)

writeData(wbAllTW_WB,"data",BQESE.TW_export,startRow = 1,startCol = 1)
writeData(wbAllTW_WB,"notes",notes,startRow = 1,startCol = 1)

saveWorkbook(wbAllTW_WB,file =here("DataCreated","BQESEdatTW_WFDallCycles.xlsx"),overwrite = TRUE)

#Save rds and csv also
saveRDS(BQESE.TW, here("Data","BQESEdatTW_WFDallCyclesAggrWB.rds"))

#CW
BQESE.CW <- inner_join(
  BQE_CWWB_unique,
  WQ_CWWB_unique, 
  by = c("waterBodyIdentifier", "cYear", "countryCode")) %>%
 mutate(DateCreated = Sys.time())

#order df variables :
BQESE.CW <- BQESE.CW %>%
  rename(
    waterBodyName.WISEbio = waterBodyName.x,
    waterBodyName.WISEse  = waterBodyName.y
  ) %>%
  select(
    cYear, countryCode, parameterNaturalAWBHMWB, 
    waterBodyIdentifier, waterBodyName.WISEbio, waterBodyName.WISEse,
    parameterNCSWaterBodyType, surfaceWaterBodyIntercalibrationType,
    surfaceWaterBodyIntercalibrationTypeCode,
    matches("EQS") %>% sort(), # all columns containing "EQS", alphabetical
    matches("_Mn") %>% sort(),  # all columns containing "_Mn", alphabetical
    "DateCreated", # last column
    everything()
  )

notes <- "All cycles WFD CW EQS classifications (WISE4&2) aggr by WB and WFD Cycle to WISE6 SoE WQ data averaged by WB and Cycle. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes,here("DataCreated","BQESEdatCW_WFDallCycles_ReadMe.txt"))

#Save BQE-SE combined data as xlsx workbook
wbAllCW_WB <- createWorkbook()

addWorksheet(wbAllCW_WB,"data")
addWorksheet(wbAllCW_WB, "notes")

# Clean NA before writing
BQESE.TW_export <- fix_excel_na(BQESE.CW)


writeData(wbAllCW_WB,"data",BQESE.TW_export,startRow = 1,startCol = 1)
writeData(wbAllCW_WB,"notes",notes,startRow = 1,startCol = 1)

saveWorkbook(wbAllCW_WB,file =here("DataCreated","BQESEdatCW_WFDallCycles.xlsx"),overwrite = TRUE)

#Save rds and csv also
saveRDS(BQESE.CW, here("Data","BQESEdatCW_WFDallCyclesAggrWB.rds"))
```

#D1. Duplicates report if desired
Data averaged by WB and Reporting Cycle
```{r BQE and WQ AggrWB and Cycle data DUPLICTAES report}

#------------------------------
# Function to detect duplicates
#------------------------------
find_duplicates <- function(df, df_name,
                            key_cols = c("waterBodyIdentifier", "cYear")) {
  
  # 1. Duplicate keys only
  dup_keys <- df %>%
    count(across(all_of(key_cols))) %>%
    filter(n > 1) %>%
    arrange(desc(n))
  
  # 2. Full duplicated rows for those keys
  dup_rows <- df %>%
    semi_join(dup_keys, by = key_cols) %>%
    arrange(across(all_of(key_cols)))
  
  # 3. For each duplicate block, detect columns with different values
  differing_vars <- dup_rows %>%
    group_by(across(all_of(key_cols))) %>%
    summarise(across(everything(), ~ n_distinct(.x, na.rm = TRUE)),
              .groups = "drop") %>%
    mutate(across(everything(), ~ ifelse(.x > 1, TRUE, FALSE))) %>%
    pivot_longer(-all_of(key_cols), names_to = "variable",
                 values_to = "different") %>%
    filter(different)

  # return list
  list(
    dataset = df_name,
    duplicate_keys = dup_keys,
    duplicate_rows = dup_rows,
    differing_columns = differing_vars
  )
}

#-------------------------------------
# Apply to all four datasets
#-------------------------------------

duplicate_report <- list(
  BQE_TW = find_duplicates(BQE_TWWB_Cycle_clean, "BQE_TWWB_Cycle_clean"),
  BQE_CW = find_duplicates(BQE_CWWB_Cycle_clean, "BQE_CWWB_Cycle_clean"),
  WQ_TW  = find_duplicates(WQ_TWWB_Cycle_clean,  "WQ_TWWB_Cycle_clean"),
  WQ_CW  = find_duplicates(WQ_CWWB_Cycle_clean,  "WQ_CWWB_Cycle_clean")
)

#-------------------------------------
# Write to Excel (optional)
#-------------------------------------
wb <- createWorkbook()

for (nm in names(duplicate_report)) {
  rep <- duplicate_report[[nm]]

  addWorksheet(wb, paste0(nm, "_keys"))
  writeData(wb, paste0(nm, "_keys"), rep$duplicate_keys)

  addWorksheet(wb, paste0(nm, "_rows"))
  writeData(wb, paste0(nm, "_rows"), rep$duplicate_rows)

  addWorksheet(wb, paste0(nm, "_diff"))
  writeData(wb, paste0(nm, "_diff"), rep$differing_columns)
}

saveWorkbook(wb, here("DataCreated","Duplicate_Report_TW_CW_BQE_WQ.xlsx"), overwrite = TRUE)


```

