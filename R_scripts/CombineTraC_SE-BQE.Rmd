---
title: "CombineTraC_SE-BQE"
author: "HT"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(openxlsx)
library(tidyverse)
library(dplyr)
library(tidyr)
```

## Description of combining WQ and BQE data for TraC Waters
This script joins the previously extracted water quality data (WQ from WISE-6) for selected supporting elements (SE) to the biological classifications (BQE from WISE-4 & WISE-2), for both TRaC water categories (TW & CW). 

* WQ (SE) - From WISE6, this script uses the previously source Site disaggregated SE data summarised (mean) by Year and Site and the source Site aggregated data by year, which are here merged before they are combined with BQE data.

* BQE - From WISE2, EQR & EQS aggregated by Site (yearly), except for EE, IE and SI for which only already aggregated data by WB was available at source, so the EQR & EQS aggWB data was also extracted (for all countries and for those 4 countries). Data was extracted for all years available until 2023.

* BQE - From WISE4, only WB aggregated EQS data (i.e., categories, not EQR) was available for the 1st and 2nd reporting cycle years 2010 and 2016.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(openxlsx)
library(tidyverse)
library(dplyr)
library(tidyr)
```

### C1. Import all data WQ-SE and BQE data
Import Water Quality Supporting Elements and Biological Quality Elements data from prepared datasets
```{r import WQ & Bio data }
#import data
Dets <- read.xlsx(here("Data","Determinands.xlsx"))

#SiteMean-Yearly data
#TW
BQEsiteMnYr.TW <- read.xlsx(here("DataCreated","BQEdatTW_siteMean_year_wise2.xlsx")) #EQR & EQS
SEsiteMnYr.TW <- read.xlsx(here("DataCreated","WQdatTW_siteMean_year.xlsx")) #SE
#CW
BQEsiteMnYr.CW <- read.xlsx(here("DataCreated","BQEdatCW_siteMean_year_wise2.xlsx")) #EQR & EQS
SEsiteMnYr.CW <- read.xlsx(here("DataCreated","WQdatCW_siteMean_year.xlsx")) #SE

#WBmean-Yearly data
#EQR & EQS
BQEwbMnYr.TRaC <- read.xlsx(here("DataCreated","BQEdatTRaC_aggWB_year_wise2.xlsx")) #All TRaC categories
#SE
SEwbMnYr.TW <- read.xlsx(here("DataCreated","WQdatTW_aggWBmean_year.xlsx")) #TW 
SEwbMnYr.CW <- read.xlsx(here("DataCreated","WQdatCW_aggWBmean_year.xlsx")) #CW

#WBmean-Cycle data
#EQS 
BQEEQSwbMnCycles.TRaC <- read.xlsx(here("DataCreated","BQEdat-EQS_aggrWBCycles_ICtypes.xlsx")) #All TRaC categories
#EQR &EQS
#BQE-EQSwbMnCycles.TRaC to be generated from object BQEwbMnYr.TRaC
#SE
SEwbMnCycles.TW <- read.xlsx(here("DataCreated","WQdatTRaC_aggWBmean_Cycle.xlsx"), sheet = "TW") #TW 
SEwbMnCycles.CW <- read.xlsx(here("DataCreated","WQdatTRaC_aggWBmean_Cycle.xlsx"), sheet = "CW") #CW 
```

### C2. Combine BQE & SE data averaged by Site and Year
```{r Add season to TW BQE datasets}
#add Season to datasets from "parameterSamplingPeriod"
#TW
BQEsiteMnYr.TW <- BQEsiteMnYr.TW %>% 
  mutate(
    Season = case_when(
      # Annual patterns
      parameterSamplingPeriod == "" |
      grepl("^[0-9]{4}-0[1-3]{1}--[0-9]{4}-12$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-3]{1}-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
        
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) | 
      grepl("^[0-9]{4}-10-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) ~ "Annual",

      # Winter (12,1,2)
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12--[0-9]{4}-0[1-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-0[1-3]{1}$", parameterSamplingPeriod) ~ "Winter",

      # Spring (3,4,5)
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-0[3-7]{1}-[0-9]{2}$", parameterSamplingPeriod) | #periods including m6/7 assumed Spring 
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-0[3-7]{1}$", parameterSamplingPeriod) ~ "Spring",
      
      # Summer (6,7,8)
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-0[6-9]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-0[6-9]{1}$", parameterSamplingPeriod) ~ "Summer", #periods including m9 assumed Summer
      
      # Summer + Autumn combined
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) ~ "SummerAutumn",

      # Autumn (9,10,11)
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "Autumn", #periods including m12 assumed Autumn
      
      # Spring + Summer + Autumn combined
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "SpringSummerAutumn",

      # default: keep original
      TRUE ~ parameterSamplingPeriod
    )
  )

#check
unique(BQEsiteMnYr.TW$Season)

```

```{r Add season to CW BQE datasets}
#add Season to datasets from "parameterSamplingPeriod"

#CW BQE seasonality
BQEsiteMnYr.CW <- BQEsiteMnYr.CW %>% 
  mutate(
    Season = case_when(
      # Annual patterns
      parameterSamplingPeriod == "" |
      grepl("^[0-9]{4}-0[1-3]{1}--[0-9]{4}-12$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-3]{1}-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
        
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) | 
      grepl("^[0-9]{4}-10-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) ~ "Annual",

      # Winter (12,1,2)
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12--[0-9]{4}-0[1-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-0[1-3]{1}$", parameterSamplingPeriod) ~ "Winter",

      # Spring (3,4,5)
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-0[3-7]{1}-[0-9]{2}$", parameterSamplingPeriod) | #periods including m6/7 assumed Spring 
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-0[3-7]{1}$", parameterSamplingPeriod) ~ "Spring",
      
      # Summer (6,7,8)
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-0[6-9]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-0[6-9]{1}$", parameterSamplingPeriod) ~ "Summer", #periods including m9 assumed Summer
      
      # Summer + Autumn combined
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) ~ "SummerAutumn",

      # Autumn (9,10,11)
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "Autumn", #periods including m12 assumed Autumn
      
      # Spring + Summer + Autumn combined
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "SpringSummerAutumn",

      # default: keep original
      TRUE ~ parameterSamplingPeriod
    )
  )

#check
unique(BQEsiteMnYr.CW$Season)
```

```{r WQ TW SiteMean-Yearly to Wide format}
Det.TW <- levels(factor(SEsiteMnYr.TW$Det))

SEsiteMnYrTW.wide <-SEsiteMnYr.TW %>%
  select(countryCode,monitoringSiteIdentifier,monitoringSiteIdentifierScheme,
          waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         phenomenonTimeReferenceYear,Season,Det,resultMeanValue
         ) %>%
   pivot_wider(names_from = Det,
               values_from = resultMeanValue,
               values_fn = mean)  %>% # mean e.g. when more than one sample depth 
   rename_with(~paste0(.x,"_Mn"),any_of(Det.TW))#all_of(Det.TW)

#check
any(duplicated(SEsiteMnYrTW.wide))

```

```{r WQ CW SiteMean-Yearly to Wide format}
Det.CW <- levels(factor(SEsiteMnYr.CW$Det))

SEsiteMnYrCW.wide <-SEsiteMnYr.CW %>%
  select(countryCode,monitoringSiteIdentifier,monitoringSiteIdentifierScheme,
          waterBodyName,waterBodyIdentifier,naturalAWBHMWB,surfaceWaterBodyTypeCode,
         phenomenonTimeReferenceYear,Season,Det,resultMeanValue
         ) %>%
   pivot_wider(names_from = Det, 
               values_from = resultMeanValue,
               values_fn = mean # mean e.g. when more than one sample depth 
               )  %>%
   rename_with(~paste0(.x,"_Mn"),any_of(Det.CW))#all_of(Det.CW)

#check
any(duplicated(SEsiteMnYrCW.wide))
```

```{r Join TW SE and BQE classifications per Site-Year (nEQR & EQS)}
#TW
names(SEsiteMnYrTW.wide)
names(BQEsiteMnYr.TW)

intersect(names(BQEsiteMnYr.TW), names(SEsiteMnYrTW.wide))

# merge Biology and SE
BQESEdat_SiteMnYrTW <- inner_join(BQEsiteMnYr.TW, 
                                 SEsiteMnYrTW.wide,
                                 by = c("countryCode", #"monitoringSiteIdentifier", 
                                        "monitoringSiteIdentifierScheme", "waterBodyIdentifier", "waterBodyName",
                                        "parameterNaturalAWBHMWB" = "naturalAWBHMWB",
                                        #"parameterNCSWaterBodyType" = "surfaceWaterBodyTypeCode",
                                        "phenomenonTimeReferenceYear", "Season"))

BQESEdat_SiteMnYrTW <- BQESEdat_SiteMnYrTW %>% select (
  -monitoringSite_WB_ID, -Created
)

notes <- "WFD Transitional waters (TW) Biological Quality classification (nEQR & EQS) (from WISE2) linked to (WISE6 SoE) (per waterbody code as SE and BQE monitoring sites codes often differ) WQ data averaged by Site and Year, for all years available, with sampling Season information discriminated. For SE units see Determinands.xlsx file. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes, here("DataCreated","BQESEdat_SiteMnYrTW_ReadMe.txt"))

#Save as xlsx workbook
wb <- createWorkbook()
addWorksheet(wb,"data")
addWorksheet(wb, "notes")
writeData(wb,"data",BQESEdat_SiteMnYrTW,startRow = 1,startCol = 1)
writeData(wb,"notes",notes,startRow = 1,startCol = 1)
saveWorkbook(wb,file =here("DataCreated","BQESEdat_SiteMnYrTW.xlsx"),overwrite = TRUE)
```

```{r Join CW SE and BQE classifications per Site-Year (nEQR & EQS)}
#CW
names(BQEsiteMnYr.CW)
names(SEsiteMnYrCW.wide)

intersect(names(BQEsiteMnYr.CW), names(SEsiteMnYrCW.wide))

# merge Biology and SE
BQESEdat_SiteMnYrCW <- inner_join(BQEsiteMnYr.CW, 
                                 SEsiteMnYrCW.wide,
                                 by = c("countryCode", #"monitoringSiteIdentifier", 
                                        "monitoringSiteIdentifierScheme", "waterBodyIdentifier", "waterBodyName",
                                        "parameterNaturalAWBHMWB" = "naturalAWBHMWB",
                                        "parameterNCSWaterBodyType" = "surfaceWaterBodyTypeCode",
                                        "phenomenonTimeReferenceYear", "Season"))

BQESEdat_SiteMnYrCW <- BQESEdat_SiteMnYrCW %>% select (
  -monitoringSite_WB_ID, -Created
)
 
notes <- "WFD Coastal waters (CW) Biological Quality classification (nEQR & EQS) (from WISE2) linked to (WISE6 SoE) (per waterbody code as SE and BQE monitoring sites codes often differ) WQ data averaged by Site and Year, for all years available, with sampling Season information discriminated. For SE units see Determinands.xlsx file. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes, here("DataCreated","BQESEdat_SiteMnYrCW_ReadMe.txt"))

#Save as xlsx workbook
wb <- createWorkbook()
addWorksheet(wb,"data")
addWorksheet(wb, "notes")
writeData(wb,"data",BQESEdat_SiteMnYrCW,startRow = 1,startCol = 1) #edit object name
writeData(wb,"notes",notes,startRow = 1,startCol = 1)
saveWorkbook(wb,file =here("DataCreated","BQESEdat_SiteMnYrCW.xlsx"),overwrite = TRUE) #edit file name
```

### C3. Combine BQE & SE data averaged by WaterBody and Year
```{r prepare BQE data adding Season }
#EQR & EQS WBmean-Yearly data
#1st split by water category
BQEwbMnYr.TW <- BQEwbMnYr.TRaC  %>%
  filter(parameterWaterBodyCategory == "TW") #TW

BQEwbMnYr.CW <- BQEwbMnYr.TRaC %>%
  filter(parameterWaterBodyCategory == "CW")  #CW

#add Season to datasets from "parameterSamplingPeriod"
#TW season
BQEwbMnYr.TW <- BQEwbMnYr.TW %>% 
  mutate(
    Season = case_when(
      # Annual patterns
      parameterSamplingPeriod == "" |
      grepl("^[0-9]{4}-0[1-3]{1}--[0-9]{4}-12$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-3]{1}-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
        
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) | 
      grepl("^[0-9]{4}-10-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) ~ "Annual",

      # Winter (12,1,2)
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12--[0-9]{4}-0[1-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-0[1-3]{1}$", parameterSamplingPeriod) ~ "Winter",

      # Spring (3,4,5)
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-0[3-7]{1}-[0-9]{2}$", parameterSamplingPeriod) | #periods including m6/7 assumed Spring 
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-0[3-7]{1}$", parameterSamplingPeriod) ~ "Spring",
      
      # Summer (6,7,8)
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-0[6-9]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-0[6-9]{1}$", parameterSamplingPeriod) ~ "Summer", #periods including m9 assumed Summer
      
      # Summer + Autumn combined
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) ~ "SummerAutumn",

      # Autumn (9,10,11)
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "Autumn", #periods including m12 assumed Autumn
      
      # Spring + Summer + Autumn combined
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "SpringSummerAutumn",

      # default: keep original
      TRUE ~ parameterSamplingPeriod
    )
  )

#check
unique(BQEwbMnYr.TW$Season)

#CW season
BQEwbMnYr.CW <- BQEwbMnYr.CW %>% 
  mutate(
    Season = case_when(
      # Annual patterns
      parameterSamplingPeriod == "" |
      grepl("^[0-9]{4}-0[1-3]{1}--[0-9]{4}-12$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-3]{1}-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
        
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) | 
      grepl("^[0-9]{4}-10-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) ~ "Annual",

      # Winter (12,1,2)
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-12-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}-[0-9]{2}--[0-9]{4}-0[1-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12--[0-9]{4}-0[1-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-12--[0-9]{4}-12$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[1-2]{1}--[0-9]{4}-0[1-3]{1}$", parameterSamplingPeriod) ~ "Winter",

      # Spring (3,4,5)
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-0[3-7]{1}-[0-9]{2}$", parameterSamplingPeriod) | #periods including m6/7 assumed Spring 
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-0[3-7]{1}$", parameterSamplingPeriod) ~ "Spring",
      
      # Summer (6,7,8)
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-0[6-9]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-0[6-9]{1}$", parameterSamplingPeriod) ~ "Summer", #periods including m9 assumed Summer
      
      # Summer + Autumn combined
      grepl("^[0-9]{4}-0[6-8]{1}-[0-9]{2}--[0-9]{4}-1[0-1]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[6-8]{1}--[0-9]{4}-1[0-1]{1}$", parameterSamplingPeriod) ~ "SummerAutumn",

      # Autumn (9,10,11)
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-09-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-1[0-1]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "Autumn", #periods including m12 assumed Autumn
      
      # Spring + Summer + Autumn combined
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-1[0-2]{1}-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}-[0-9]{2}--[0-9]{4}-09-[0-9]{2}$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-09$", parameterSamplingPeriod) |
      grepl("^[0-9]{4}-0[3-5]{1}--[0-9]{4}-1[0-2]{1}$", parameterSamplingPeriod) ~ "SpringSummerAutumn",

      # default: keep original
      TRUE ~ parameterSamplingPeriod
    )
  )

#check
unique(BQEwbMnYr.CW$Season)


```

```{r WQ TW WB-Yearly to Wide format}
names(SEwbMnYr.TW)

SEwbMnYrTW.wide <- SEwbMnYr.TW %>% 
  select (countryCode, waterBodyIdentifier, phenomenonTimeReferenceYear, Season, 
          Det, resultMeanValueWB
          ) %>%
  pivot_wider(names_from = Det,
              values_from = resultMeanValueWB,
              values_fn = mean # mean across for e.g. sample depth
)

any(duplicated(SEwbMnYrTW.wide)) 

names(SEwbMnYrTW.wide)
```

```{r WQ TW WB-Yearly to Wide format}
names(SEwbMnYr.CW)

SEwbMnYrCW.wide <- SEwbMnYr.CW %>% 
  select (countryCode, waterBodyIdentifier, phenomenonTimeReferenceYear, Season, 
          Det, resultMeanValueWB
          ) %>%
  pivot_wider(names_from = Det,
              values_from = resultMeanValueWB,
              values_fn = mean # mean across for e.g. sample depth
)

any(duplicated(SEwbMnYrCW.wide)) 

names(SEwbMnYrCW.wide)

```

```{r Join TW SE and BQE classifications per WB-Year (nEQR & EQS)}
intersect(names(BQEwbMnYr.TW), names(SEwbMnYrTW.wide))
# merge Biology and SE
BQESEdat_WBMnYrTW <- inner_join(BQEwbMnYr.TW,
                                SEwbMnYrTW.wide,
                                by = c("countryCode", "waterBodyIdentifier", 
                                       "phenomenonTimeReferenceYear", "Season"))

any(duplicated(BQESEdat_WBMnYrTW)) # no duplicates - OK

notes <- "WFD Transitional waters (TW) Biological Quality classification (nEQR & EQS) (from WISE2) linked to (WISE6 SoE) WQ data averaged by WaterBody and Year, for all years available, with sampling Season information discriminated. SE data averged by sample depth if several depth measurements available. For SE units see Determinands.xlsx file. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes, here("DataCreated","BQESEdat_WBMnYrTW_ReadMe.txt"))

#Save as xlsx workbook
wb <- createWorkbook()
addWorksheet(wb,"data")
addWorksheet(wb, "notes")
writeData(wb,"data",BQESEdat_WBMnYrTW,startRow = 1,startCol = 1) #edit object name
writeData(wb,"notes",notes,startRow = 1,startCol = 1)
saveWorkbook(wb,file =here("DataCreated","BQESEdat_WBMnYrTW.xlsx"),overwrite = TRUE) #edit file name
```

```{r Join CW SE and BQE classifications per WB-Year (nEQR & EQS)}
intersect(names(BQEwbMnYr.CW),names(SEwbMnYrCW.wide))

# merge Biology and SE
BQESEdat_WBMnYrCW <- inner_join(BQEwbMnYr.CW,
                                SEwbMnYrCW.wide,
                                by = c("countryCode", "waterBodyIdentifier", 
                                       "phenomenonTimeReferenceYear", "Season"))

 any(duplicated(BQESEdat_WBMnYrCW)) # no duplicates - OK

notes <- "WFD Coastal waters (CW) Biological Quality classification (nEQR & EQS) (from WISE2) linked to (WISE6 SoE) WQ data averaged by WaterBody and Year, for all years available, with sampling Season information discriminated. SE data averged by sample depth if several depth measurements available. For SE units see Determinands.xlsx file. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes, here("DataCreated","BQESEdat_WBMnYrCW_ReadMe.txt"))

#Save as xlsx workbook
wb <- createWorkbook()
addWorksheet(wb,"data")
addWorksheet(wb, "notes")
writeData(wb,"data",BQESEdat_WBMnYrCW,startRow = 1,startCol = 1) #edit object name
writeData(wb,"notes",notes,startRow = 1,startCol = 1)
saveWorkbook(wb,file =here("DataCreated","BQESEdat_WBMnYrCW.xlsx"),overwrite = TRUE) #edit file name

```

### C4. Combine BQE & SE data averaged by WaterBody and Reporting Cycle

```{r prepare BQE WB data to Cycle before combining}
#1st EQS from wise 4 split by water category BEFORE merge with SE
BQEEQSwbMnCycles.TW <- BQEEQSwbMnCycles.TRaC %>% filter (parameterWaterBodyCategory == "TW")
BQEEQSwbMnCycles.CW <- BQEEQSwbMnCycles.TRaC %>% filter (parameterWaterBodyCategory == "CW")

#2nd Aggregate EQR & EQS WB data from wise 2 by WFD Cycle BEFORE merge with SE
#add WFD Cycle year variable to wise 2 "cYear"
cYear <- list(
  `baseline`= 2000:2003,
  `2010` = 2004:2009,
  `2016` = 2010:2015,
  `2022` = 2016:2021,
  `2028` = 2022:2027
)

#TW
BQEnEQREQSwbMnCycles.TW <- BQEwbMnYr.TW %>% select(-parameterSamplingPeriod) %>%
  mutate(cYear=case_when(
    phenomenonTimeReferenceYear %in% cYear$baseline ~ 2000,
    phenomenonTimeReferenceYear %in% cYear$`2010` ~ 2010,
    phenomenonTimeReferenceYear %in% cYear$`2016` ~ 2016,
    phenomenonTimeReferenceYear %in% cYear$`2022` ~ 2022,
    phenomenonTimeReferenceYear %in% cYear$`2028` ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-phenomenonTimeReferenceYear) 

#CW
BQEnEQREQSwbMnCycles.CW <- BQEwbMnYr.CW %>% select(-parameterSamplingPeriod) %>%
  mutate(cYear=case_when(
    phenomenonTimeReferenceYear %in% cYear$baseline ~ 2000,
    phenomenonTimeReferenceYear %in% cYear$`2010` ~ 2010,
    phenomenonTimeReferenceYear %in% cYear$`2016` ~ 2016,
    phenomenonTimeReferenceYear %in% cYear$`2022` ~ 2022,
    phenomenonTimeReferenceYear %in% cYear$`2028` ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-phenomenonTimeReferenceYear) 

#3rd summarise wise2 BQE EQR/EQS data per per WB and WFD cycle
#TW
BQEnEQREQSwbMnCycles.TW <- BQEnEQREQSwbMnCycles.TW %>% 
  group_by(parameterWaterBodyCategory, countryCode, waterBodyIdentifier,
           waterBodyName, parameterNCSWaterBodyType, 
           parameterNaturalAWBHMWB, metadata_versionId,
           observedPropertyDeterminandLabel, procedureClassificationSystem,
           Season, cYear
           ) %>%
  summarise(across(
    c("resultEcologicalStatusClassValue","resultEQRValue","resultNormalisedEQRValue"),
    ~ mean(.x, na.rm = TRUE)
    ),
    resultNumberOfSamples = sum(resultNumberOfSamples, na.rm = TRUE),
    .groups = "drop"
  )
  
#CW
BQEnEQREQSwbMnCycles.CW <- BQEnEQREQSwbMnCycles.CW %>%
  group_by(parameterWaterBodyCategory, countryCode, waterBodyIdentifier,
           waterBodyName, parameterNCSWaterBodyType, 
           parameterNaturalAWBHMWB, metadata_versionId,
           observedPropertyDeterminandLabel, procedureClassificationSystem,
           Season, cYear
           ) %>%
  summarise(across(
    c("resultEcologicalStatusClassValue","resultEQRValue","resultNormalisedEQRValue"),
    ~ mean(.x, na.rm = TRUE)
    ),
    resultNumberOfSamples = sum(resultNumberOfSamples, na.rm = TRUE),
    .groups = "drop"
  )

#4th pivot wide wise 2
BQEnEQREQSwbMnCyclesTW.wide <- BQEnEQREQSwbMnCycles.TW %>% 
  select(-parameterWaterBodyCategory, -resultNumberOfSamples, -resultEQRValue, -procedureClassificationSystem, - metadata_versionId) %>%
  pivot_wider(names_from = observedPropertyDeterminandLabel,
              values_from = c(resultEcologicalStatusClassValue, resultNormalisedEQRValue),
              values_fn = list(
                resultEcologicalStatusClassValue = ~ mean(.x, na.rm = TRUE),
                resultNormalisedEQRValue = ~ mean(.x, na.rm = TRUE))
  ) %>%
  rename_with(
    ~ str_replace(.x, "^resultEcologicalStatusClassValue_(.*)", "\\1_EQS"),
    starts_with("resultEcologicalStatusClassValue_")
  ) %>%
  rename_with(
    ~ str_replace(.x, "^resultNormalisedEQRValue_(.*)", "\\1_nEQR"),
    starts_with("resultNormalisedEQRValue_")
  ) %>%
  mutate(across(
    ends_with("_EQS"), ~ as.integer(round(.x)), .names = "{.col}" # round to integer
  )) %>% 
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.x), NA, .x)))

any(duplicated(BQEnEQREQSwbMnCyclesTW.wide)) 

#CW
BQEnEQREQSwbMnCyclesCW.wide <- BQEnEQREQSwbMnCycles.CW %>% 
  select(-parameterWaterBodyCategory, -resultNumberOfSamples, -resultEQRValue, -procedureClassificationSystem, - metadata_versionId) %>%
  pivot_wider(names_from = observedPropertyDeterminandLabel,
              values_from = c(resultEcologicalStatusClassValue, resultNormalisedEQRValue),
              values_fn = list(
                resultEcologicalStatusClassValue = ~ mean(.x, na.rm = TRUE),
                resultNormalisedEQRValue = ~ mean(.x, na.rm = TRUE))
  ) %>%
  rename_with(
    ~ str_replace(.x, "^resultEcologicalStatusClassValue_(.*)", "\\1_EQS"),
    starts_with("resultEcologicalStatusClassValue_")
  ) %>%
  rename_with(
    ~ str_replace(.x, "^resultNormalisedEQRValue_(.*)", "\\1_nEQR"),
    starts_with("resultNormalisedEQRValue_")
  ) %>%
  mutate(across(
    ends_with("_EQS"), ~ as.integer(round(.x)), .names = "{.col}" # round to integer
  )) %>% 
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.x), NA, .x))) 

any(duplicated(BQEnEQREQSwbMnCyclesCW.wide)) 

```

```{r prepare SE WB data to Cycle before combining}
#prepare SE for merge per WFD Cycle
#add cYear variable
#TW
SEwbMnCycles.TW <- SEwbMnCycles.TW %>%
  mutate(cYear=case_when(
    period_sheet == "2000_2003" ~ 2000,
    period_sheet == "2004_2009" ~ 2010,
    period_sheet == "2010_2015" ~ 2016,
    period_sheet == "2016_2021" ~ 2022,
    period_sheet == ">2022" ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-period_sheet)

#CW
SEwbMnCycles.CW <- SEwbMnCycles.CW %>%
  mutate(cYear=case_when(
    period_sheet == "2000_2003" ~ 2000,
    period_sheet == "2004_2009" ~ 2010,
    period_sheet == "2010_2015" ~ 2016,
    period_sheet == "2016_2021" ~ 2022,
    period_sheet == ">2022" ~ 2028,
    TRUE ~ NA_real_
    )
    ) %>%
  select(-period_sheet)

```

```{r Join SE and BQE classifications WB-Cycle}
#merge BQE and SE using inner_join to keep only biological data observations that have corresponding data in WQ
SEwbMnCycles.TW <- SEwbMnCycles.TW %>% select(-source, -nYears)
SEwbMnCycles.CW <- SEwbMnCycles.CW %>% select(-source, -nYears)

#1st before joining check for duplicates - None! OK
any(duplicated(SEwbMnCycles.CW)) # edit object to be checked

#2nd join BQE and WQ data
#EQS wise 4 * SE wise 6
BQESEdat_WBCycleTW_wise4EQS <- inner_join(BQEEQSwbMnCycles.TW,
                                          SEwbMnCycles.TW,
                                          by = c("countryCode", "waterBodyIdentifier",
                                                 "waterBodyName", "cYear")) %>%
  mutate(DateCreated = Sys.time())

BQESEdat_WBCycleCW_wise4EQS <- inner_join(BQEEQSwbMnCycles.CW, 
                                          SEwbMnCycles.CW,
                                          by = c("countryCode", "waterBodyIdentifier",
                                                 "waterBodyName", "cYear")) %>%
  mutate(DateCreated = Sys.time())

#EQR/EQS wise 2 * SE wise 6
intersect(names(BQEnEQREQSwbMnCyclesTW.wide),names(SEwbMnCycles.TW))

BQESEdat_WBCycleTW_wise2eqrEQS <- inner_join(BQEnEQREQSwbMnCyclesTW.wide,
                                             SEwbMnCycles.TW,
                                             by = c("countryCode", "waterBodyIdentifier",
                                                 "waterBodyName", "cYear", "Season"),
                                             relationship = "many-to-many") %>%
   mutate(DateCreated = Sys.time())

BQESEdat_WBCycleCW_wise2eqrEQS <- inner_join(BQEnEQREQSwbMnCyclesCW.wide, 
                                             SEwbMnCycles.CW,
                                             by = c("countryCode", "waterBodyIdentifier",
                                                 "waterBodyName", "cYear", "Season"),
                                             relationship = "many-to-many") %>%
  mutate(DateCreated = Sys.time())

```

```{r Save WQ and BQE data aggregated per WB & Cycle}
#merge Biology and SE using inner_join to keep only BQE observations that have corresponding data in WQ

# --- Function to clean NA for Excel ---
fix_excel_na <- function(df) {
  df %>%
    mutate(across(where(is.numeric),
                  ~ ifelse(is.na(.x), "", .x)))
}

notes <- "Combined WQ and BQE data aggregated per WB and WFD Cycle for WFD TW & CW EQS classifications (WISE4) and for WFD TW & CW nEQR and EQS classificationsto (WISE2) with WISE6 SoE WQ data averaged by WB and Cycle. Created in CombineTraC_SE-BQE.Rmd"
writeLines(notes,here("DataCreated","BQESEdat_WBCycle-TRaC_wise4EQS-wise2nEQR-EQS_ReadMe.txt"))

# Clean NA before writing
BQESEdat_WBCycleTW_wise4EQS_export <- fix_excel_na(BQESEdat_WBCycleTW_wise4EQS)
BQESEdat_WBCycleCW_wise4EQS_export <- fix_excel_na(BQESEdat_WBCycleCW_wise4EQS)

BQESEdat_WBCycleTW_wise2eqrEQS_export <- fix_excel_na(BQESEdat_WBCycleTW_wise2eqrEQS)
BQESEdat_WBCycleCW_wise2eqrEQS_export <- fix_excel_na(BQESEdat_WBCycleCW_wise2eqrEQS)

#Save BQE-SE combined data as xlsx 
write.xlsx(BQESEdat_WBCycleTW_wise4EQS_export,here("DataCreated","BQESEdat_WBCycleTW_wise4EQS.xlsx"))
write.xlsx(BQESEdat_WBCycleCW_wise4EQS_export,here("DataCreated","BQESEdat_WBCycleCW_wise4EQS.xlsx"))

write.xlsx(BQESEdat_WBCycleTW_wise2eqrEQS_export,here("DataCreated","BQESEdat_WBCycleTW_wise2nEQR_EQS.xlsx"))
write.xlsx(BQESEdat_WBCycleCW_wise2eqrEQS_export,here("DataCreated","BQESEdat_WBCycleCW_wise2nEQR_EQS.xlsx"))

#Save rds
saveRDS(BQESEdat_WBCycleTW_wise4EQS_export, here("Data","BQESEdat_WBCycleTW_wise4EQS.rds"))
saveRDS(BQESEdat_WBCycleCW_wise4EQS_export, here("Data","BQESEdat_WBCycleCW_wise4EQS.rds"))
saveRDS(BQESEdat_WBCycleTW_wise2eqrEQS_export, here("Data","BQESEdat_WBCycleTW_wise2nEQR_EQS.rds"))
saveRDS(BQESEdat_WBCycleCW_wise2eqrEQS_export, here("Data","BQESEdat_WBCycleCW_wise2nEQR_EQS.rds"))

```

